<!DOCTYPE html>

<html lang="de">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<title>Vokabeltrainer</title>
<style>
    :root{
      --gap: 12px;
        
      --bg1:#f6f3ff;
      --bg2:#eef2ff;

      --card:#ffffff;
      --text:#0f172a;
      --muted:#64748b;

      --line: rgba(15,23,42,.08);
      --shadow1: 0 10px 30px rgba(15,23,42,.08);
      --shadow2: 0 2px 12px rgba(15,23,42,.06);

      --r20: 20px;
      --r18: 18px;
      --r16: 16px;
      --r14: 14px;
      --r12: 12px;

      --primaryA:#2563eb;
      --primaryB:#7c3aed;

      --okBorder:#bfe5c9;
      --okBg:#f2fbf4;
      --badBorder:#f0c0c6;
      --badBg:#fff7f8;
    }

    *{ box-sizing: border-box; }
    html, body { max-width: 100%; overflow-x: hidden; }

    body{
      margin:0;
      font-family: -apple-system, system-ui, Segoe UI, Roboto, Arial, sans-serif;
      color: var(--text);
      background:
        radial-gradient(1000px 500px at 50% 0%, var(--bg1), transparent 60%),
        radial-gradient(900px 600px at 40% 30%, var(--bg2), transparent 60%),
        #f7f7fb;
    }

    main{
      width:100%;
      max-width: 460px;
      margin: 22px auto;
      padding: 0 14px 22px;
      display:grid;
      gap: 14px;
    }

    .card{
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: var(--r20);
      box-shadow: var(--shadow2);
      padding: 14px;
    }

    .row{ display:flex; align-items:center; gap: var(--gap); flex-wrap: wrap; }
    .stack{ display:grid; gap: 10px; }

    .small{ font-size:12px; color: var(--muted); }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; }
    .big{ font-size: 20px; font-weight: 900; line-height: 1.25; }
    .right{ margin-left:auto; }

    .appTitle{
      display:flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      font-weight: 900;
      font-size: 22px;
      color:#5b21b6;
      margin: 4px 0 10px;
    }
    .spark{
      width:20px;height:20px;
      display:inline-grid; place-items:center;
      color:#7c3aed;
    }

    /* Stats */
    .stats{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      margin-bottom: 12px;
    }
    .stat{
      background:#fff;
      border: 1px solid var(--line);
      border-radius: var(--r18);
      padding: 10px;
      box-shadow: 0 1px 0 rgba(0,0,0,0.02);
    }
    .stat .num{ font-size: 20px; font-weight: 900; line-height:1; }
    .stat .lbl{ font-size: 12px; color: var(--muted); margin-top: 4px; }

    /* Controls */
    button, select, input { font: inherit; }
    button{
      border: 1px solid rgba(15,23,42,.12);
      background: #fff;
      padding: 10px 12px;
      border-radius: var(--r16);
      cursor: pointer;
      box-shadow: 0 1px 0 rgba(0,0,0,0.02);
    }
    button:disabled{ opacity:.55; cursor:not-allowed; }
    button.danger{
      background:#fff;
      color:#b00020;
      border-color: rgba(176,0,32,.18);
    }
    .btnPrimary{
      width:100%;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      border: 0;
      padding: 12px 14px;
      border-radius: var(--r18);
      color:#fff;
      font-weight: 900;
      background: linear-gradient(90deg, var(--primaryA), var(--primaryB));
      box-shadow: var(--shadow1);
    }

    /* List items */
    .item{
      display:flex;
      align-items:center;
      gap: 12px;
      padding: 12px 12px;
      border-radius: var(--r18);
      border: 1px solid var(--line);
      background: #fff;
      box-shadow: 0 1px 0 rgba(0,0,0,0.02);
      cursor: pointer;
    }
    .item:active{ transform: translateY(1px); }
    .ic{
      width: 32px; height: 32px;
      border-radius: 999px;
      display:grid; place-items:center;
      background: rgba(124,58,237,.12);
      color:#7c3aed;
      flex: 0 0 auto;
      font-weight: 900;
    }
    .txt{ display:grid; min-width: 0; }
    .txt strong{ font-size: 14px; }
    .txt span{ font-size: 12px; color: var(--muted); margin-top:2px; }
    .chev{ margin-left:auto; color: rgba(15,23,42,.35); font-size: 20px; }

    .sectionLbl{
      display:flex;
      align-items:center;
      gap: 8px;
      color: rgba(15,23,42,.75);
      font-weight: 900;
      font-size: 13px;
      margin-top: 10px;
      margin-bottom: 2px;
    }
    .mini{
      width:18px;height:18px;
      display:grid; place-items:center;
      color:#f59e0b;
    }

    /* Pills */
    .pill{
      display:inline-flex;
      align-items:center;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.72);
      font-size: 12px;
      color: rgba(15,23,42,.85);
    }

    /* Learn overlay */
    .overlay{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.35);
      display: none;
      z-index: 999;
    }
    .overlay.open{ display:block; }
    .overlayPanel{
      position:absolute;
      inset: 10px;
      background: rgba(247,247,251,1);
      border-radius: var(--r20);
      padding: 10px;
      overflow:auto;
      border: 1px solid rgba(255,255,255,.55);
      box-shadow: var(--shadow1);
    }
    body.noscroll{ overflow:hidden; }

    .answer{
      padding: 12px;
      border: 1px dashed rgba(15,23,42,.18);
      border-radius: var(--r18);
      background: rgba(255,255,255,.75);
      margin-top: 10px;
    }
    .choices{ display:grid; gap: 8px; margin-top: 10px; }
    .choices button{ text-align:left; }

    .ok{ border-color: var(--okBorder) !important; background: var(--okBg) !important; }
    .bad{ border-color: var(--badBorder) !important; background: var(--badBg) !important; }

    /* Modal (Pop-up Auswahl) */
    .modal{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.35);
      display:none;
      z-index: 1000;
    }
    .modal.open{ display:block; }
    .modalPanel{
      position: absolute;
      left: 10px; right: 10px; bottom: 10px;
      background: #fff;
      border-radius: var(--r20);
      border: 1px solid var(--line);
      box-shadow: var(--shadow1);
      overflow: hidden;
      max-height: calc(100vh - 20px);
      display:flex;
      flex-direction: column;
    }
    .modalHead{
      padding: 12px 12px;
      display:flex;
      align-items:center;
      gap: 10px;
      border-bottom: 1px solid var(--line);
      background: rgba(255,255,255,.9);
    }
    .modalHead strong{ font-size: 14px; }
    .modalBody{
      padding: 12px;
      overflow:auto;
      display:grid;
      gap: 10px;
    }
    .modalFoot{
      padding: 12px;
      border-top: 1px solid var(--line);
      display:flex;
      gap: 10px;
      justify-content:flex-end;
      background: rgba(255,255,255,.9);
    }
    .field{
      display:grid;
      gap: 6px;
    }
    .field label{
      font-size: 12px;
      color: rgba(15,23,42,.8);
      font-weight: 800;
    }
    .field select, .field input{
      width:100%;
      padding: 10px;
      border-radius: var(--r16);
      border: 1px solid var(--line);
      background:#fff;
      outline:none;
    }

    /* Tags list */
    .tagList{
      display:grid;
      gap: 8px;
    }
    .tagRow{
      display:flex;
      align-items:center;
      gap: 10px;
      padding: 10px 10px;
      border: 1px solid var(--line);
      border-radius: var(--r16);
      background: #fff;
    }
    .tagRow input[type="checkbox"]{ width:18px; height:18px; }
    .tagRow .name{ font-weight: 900; font-size: 13px; }
    .tagRow .date{ margin-left:auto; font-size: 12px; color: var(--muted); }

    /* CSV */
    details.csvBlock summary{
      list-style:none;
      cursor:pointer;
      user-select:none;
      display:flex;
      align-items:center;
      gap: 10px;
      font-weight: 900;
      font-size: 13px;
      color: rgba(15,23,42,.85);
    }
    details.csvBlock summary::-webkit-details-marker{ display:none; }

    .tableWrap{
      overflow:auto;            /* horizontal + vertical inside */
      border: 1px solid var(--line);
      border-radius: var(--r18);
      background: #fff;
      max-height: 280px;
      margin-top: 10px;
    }
    table.csv{
      border-collapse: collapse;
      width: max-content;
      min-width: 100%;
    }
    table.csv th, table.csv td{
      border-bottom: 1px solid rgba(15,23,42,.06);
      padding: 7px 9px;
      white-space: nowrap;
      font-size: 11px;          /* deutlich kleiner */
      vertical-align: top;
    }
    table.csv th{
      position: sticky;
      top: 0;
      background: #fbfcfe;
      text-align: left;
      color: rgba(15,23,42,.7);
    }

    .vocabList{
      display:grid;
      gap: 10px;
      margin-top: 10px;
    }
    
    .vocabEntry{
      border: 1px solid var(--line);
      border-radius: var(--r18);
      background:#fff;
      overflow:hidden;
    }
    
    .vocabEntry summary{
      list-style:none;
      cursor:pointer;
      user-select:none;
      padding: 12px 12px;
      display:flex;
      align-items:center;
      gap: 10px;
    }
    
    .vocabEntry summary::-webkit-details-marker{ display:none; }
    
    .vocabWord{
      font-weight: 900;
      font-size: 15px;
      line-height: 1.2;
      overflow:hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    
    .vocabMeta{
      margin-left:auto;
      font-size: 12px;
      color: var(--muted);
      flex: 0 0 auto;
    }
    
    .vocabBody{
      padding: 0 12px 12px;
      display:grid;
      gap: 8px;
    }
    
    .vocabLine{
      font-size: 13px;
      color: rgba(15,23,42,.9);
      word-break: break-word;   /* bleibt in der Breite */
    }
    
    .vocabLine .k{
      font-size: 12px;
      color: var(--muted);
      font-weight: 800;
      margin-right: 6px;
    }

  </style>
</head>
<body>
<!-- Lern-Overlay -->
<div aria-hidden="true" class="overlay" id="learnOverlay">
<div class="overlayPanel">
<div class="row" style="margin-bottom: 10px;">
<strong>Lernen</strong>
<span class="right small" id="overlayStatus"></span>
<button id="closeOverlayBtn">Zur√ºck</button>
<button disabled="" id="nextBtn2">N√§chste</button>
<button class="danger" disabled="" id="endBtn2">Beenden</button>
</div>
<div id="learnCardInner"></div>
</div>
</div>
<!-- Auswahl-Modal -->
<div aria-hidden="true" class="modal" id="modal">
<div aria-modal="true" class="modalPanel" role="dialog">
<div class="modalHead">
<strong id="modalTitle">Auswahl</strong>
<span class="right"></span>

</div>
<div class="modalBody" id="modalBody"></div>
<div class="modalFoot">

<button class="btnPrimary" id="modalOkBtn" style="width:auto; padding:10px 12px;">OK</button>
</div>
</div>
</div>
<main>
<section class="card">
<div class="appTitle">
<span class="spark">‚ú¶</span>
<span>Vokabeltrainer</span>
</div>
<button class="btnPrimary" disabled="" id="startBtn">Ôºã Session starten</button>
<div class="stack" style="margin-top:12px;">

<!-- Optionen direkt sichtbar, √∂ffnen Modals -->
<div class="item" id="pickLang">
<div class="ic" style="background: rgba(15,23,42,.06); color:#0f172a;">üåê</div>
<div class="txt">
<strong>Sprache</strong>
<span id="labelLang">‚Äî</span>
</div>
<div class="chev">‚Ä∫</div>
</div>
<div class="item" id="pickDirection">
<div class="ic" style="background: rgba(37,99,235,.12); color:#2563eb;">‚áÑ</div>
<div class="txt">
<strong>Richtung</strong>
<span id="labelDirection">‚Äî</span>
</div>
<div class="chev">‚Ä∫</div>
</div>
<div class="item" id="pickMode">
<div class="ic" style="background: rgba(124,58,237,.12); color:#7c3aed;">üéõ</div>
<div class="txt">
<strong>Modus</strong>
<span id="labelMode">‚Äî</span>
</div>
<div class="chev">‚Ä∫</div>
</div>
<div class="item" id="pickLimit">
<div class="ic" style="background: rgba(245,158,11,.14); color:#b45309;">#</div>
<div class="txt">
<strong>Anzahl Fragen</strong>
<span id="labelLimit">‚Äî</span>
</div>
<div class="chev">‚Ä∫</div>
</div>
<div class="item" id="pickLenient">
<div class="ic" style="background: rgba(15,23,42,.06); color:#0f172a;">Aa</div>
<div class="txt">
<strong>Akzente & Gro√ü/klein ignorieren</strong>
<span id="labelLenient">‚Äî</span>
</div>
<div class="chev">‚Ä∫</div>
</div>
<div class="item" id="pickTags">
<div class="ic" style="background: rgba(124,58,237,.12); color:#7c3aed;">üè∑</div>
<div class="txt">
<strong>Units/Tags</strong>
<span id="labelTags">‚Äî</span>
</div>
<div class="chev">‚Ä∫</div>
</div>

<div class="small">CSV: <span class="mono" id="csvLabel"></span></div>
</div>
</section>
<!-- CSV -->
<section class="card">
<details class="csvBlock" id="csvDetails">
<summary>
<span>Vokabeltabelle anzeigen</span>
<span class="right small" id="csvCountLabel"></span>
</summary>
<div id="vocabList" class="vocabList"></div>
<div class="small" style="margin-top:8px;">
          Read-only Anzeige der CSV-Daten
        </div>
</details>
</section>
</main>
<script>
    function getListKey() {
      const p = new URLSearchParams(location.search);
      return (p.get("list") || "default").trim().toLowerCase();
    }
    const LIST_KEY = getListKey();
    const CSV_URL = `csv/vocab_${LIST_KEY}.csv`;

    let vocab = [];

    // UI state
    let selectedLang = "ALL";
    let direction = "DE_TO_FOREIGN";
    let mode = "FLASH";
    let limitN = 0;
    let lenient = false;
    let selectedTags = new Set();

    // Session state
    let session = [];
    let idx = 0;
    let score = 0;
    let inSession = false;
    let currentDirForQuestion = "DE_TO_FOREIGN";

    const $ = (id) => document.getElementById(id);
    const status = (msg) => {
      const s = $("status");
      if (s) s.textContent = msg;
      const o = $("overlayStatus");
      if (o) o.textContent = msg;
    };

    function parseISODate(s) {
      if (!s) return null;
      const m = /^(\d{4})-(\d{2})-(\d{2})$/.exec(s.trim());
      if (!m) return null;
      const d = new Date(`${m[1]}-${m[2]}-${m[3]}T00:00:00`);
      return isNaN(d.getTime()) ? null : d;
    }

    function normalize(str, isLenient=true) {
      if (!str) return "";
      let s = str.trim();
      if (isLenient) {
        s = s.toLowerCase();
        s = s.normalize("NFD").replace(/[\u0300-\u036f]/g, "");
      }
      s = s.replace(/\s+/g, " ");
      return s;
    }

    function parseTags(tags) {
      return (tags || "")
        .split(";")
        .map(t => t.trim())
        .filter(Boolean);
    }

    function shuffle(a) {
      for (let i = a.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [a[i], a[j]] = [a[j], a[i]];
      }
      return a;
    }

    // -------------------------
    // CSV parser
    // -------------------------
    function fromCsv(text) {
      const rows = [];
      let i = 0, field = "", row = [], inQuotes = false;

      function pushField() { row.push(field); field = ""; }
      function pushRow() { rows.push(row); row = []; }

      while (i < text.length) {
        const c = text[i];
        if (inQuotes) {
          if (c === '"') {
            if (text[i+1] === '"') { field += '"'; i += 2; continue; }
            inQuotes = false; i++; continue;
          } else { field += c; i++; continue; }
        } else {
          if (c === '"') { inQuotes = true; i++; continue; }
          if (c === ',') { pushField(); i++; continue; }
          if (c === '\n') { pushField(); pushRow(); i++; continue; }
          if (c === '\r') { i++; continue; }
          field += c; i++; continue;
        }
      }
      pushField();
      if (row.length > 1 || (row[0] ?? "").trim() !== "") pushRow();
      if (rows.length === 0) return [];

      const header = rows[0].map(h => (h ?? "").trim().toLowerCase());
      const dataRows = rows.slice(1);
      const ix = (name) => header.indexOf(name);

      const idxMap = {
        id: ix("id"),
        added: ix("added"),
        de: ix("de"),
        foreign: ix("foreign"),
        lang: ix("lang"),
        tags: ix("tags"),
        example: ix("example")
      };

      const out = [];
      for (const r of dataRows) {
        const get = (k) => {
          const j = idxMap[k];
          return j >= 0 ? ((r[j] ?? "").toString().trim()) : "";
        };

        out.push({
          id: get("id"),
          added: get("added"),
          de: get("de"),
          foreign: get("foreign"),
          lang: (get("lang") || "EN").toUpperCase(),
          tags: get("tags"),
          example: get("example")
        });
      }
      return out;
    }

    // -------------------------
    // Tags recency map + sorted list
    // -------------------------
    function computeTagRecency() {
      const map = new Map();
      for (const v of vocab) {
        const d = parseISODate(v.added) || new Date(0);
        for (const t of parseTags(v.tags)) {
          const prev = map.get(t);
          if (!prev || d > prev) map.set(t, d);
        }
      }
      return map;
    }

    function tagDateStr(d) {
      if (!d) return "";
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,"0");
      const da = String(d.getDate()).padStart(2,"0");
      return `${y}-${m}-${da}`;
    }

    function getAllLangs() {
      return [...new Set(vocab.map(v => (v.lang || "EN").toUpperCase()).filter(Boolean))]
        .sort((a,b)=>a.localeCompare(b, "de"));
    }

    // -------------------------
    // Build session
    // -------------------------
    function buildSession() {
      let pool = vocab.slice();

      if (selectedLang !== "ALL") {
        pool = pool.filter(v => (v.lang || "").toUpperCase() === selectedLang);
      }

      if (selectedTags.size > 0) {
        pool = pool.filter(v => parseTags(v.tags).some(t => selectedTags.has(t)));
      }

      pool = pool.filter(v => (v.de || "").trim() && (v.foreign || "").trim());
      shuffle(pool);

      session = (limitN === 0) ? pool : pool.slice(0, Math.min(limitN, pool.length));
      idx = 0;
      score = 0;
      inSession = session.length > 0;

      return inSession;
    }

    function currentItem() { return session[idx]; }

    function qText(item) {
      const dir = currentDirForQuestion;
      return dir === "DE_TO_FOREIGN" ? item.de : item.foreign;
    }
    function aText(item) {
      const dir = currentDirForQuestion;
      return dir === "DE_TO_FOREIGN" ? item.foreign : item.de;
    }

    // -------------------------
    // Learn UI
    // -------------------------
    function renderExampleUnder(targetEl, item) {
      const ex = (item.example || "").trim();
      if (!ex) return;
      const div = document.createElement("div");
      div.className = "small";
      div.style.marginTop = "6px";
      div.textContent = `Beispiel: ${ex}`;
      targetEl.appendChild(div);
    }

    function renderLearnInner(container) {
      container.innerHTML = "";

      if (!inSession) {
        container.innerHTML = `<div class="small">Keine aktive Session. Tippe auf ‚ÄûSession starten‚Äú.</div>`;
        return;
      }

      const item = currentItem();

      // direction logic per question
      currentDirForQuestion = (direction === "BOTH")
        ? (Math.random() < 0.5 ? "DE_TO_FOREIGN" : "FOREIGN_TO_DE")
        : direction;

      const head = document.createElement("div");
      head.innerHTML = `
        <div class="small" style="margin-bottom:8px;">
          Sprache: <span class="mono">${(item.lang||"").toUpperCase()}</span>
          ¬∑ Tags: <span class="mono">${item.tags||"-"}</span>
          ¬∑ Added: <span class="mono">${item.added||"-"}</span>
        </div>
        <div class="big">${qText(item)}</div>
      `;
      container.appendChild(head);

      if (mode === "FLASH") {
        const ans = document.createElement("div");
        ans.className = "answer";
        ans.innerHTML = `
          <div class="small">Klicke ‚ÄûAufdecken‚Äú, dann bewerte dich selbst.</div>
          <div class="row" style="margin-top:10px;">
            <button id="revealBtn">Aufdecken</button>
            <span class="right"></span>
          </div>
          <div id="revealArea" style="margin-top:10px; display:none;"></div>
          <div class="row" style="margin-top:10px;">
            <button id="selfOkBtn" class="btnPrimary" style="width:auto; padding:10px 12px;" disabled>Richtig</button>
            <button id="selfBadBtn" disabled>Falsch</button>
          </div>
        `;
        container.appendChild(ans);

        $("revealBtn").onclick = () => {
          const revealArea = $("revealArea");
          revealArea.style.display = "block";
          revealArea.innerHTML = "";

          const sol = document.createElement("div");
          sol.className = "big";
          sol.textContent = aText(item);
          revealArea.appendChild(sol);

          renderExampleUnder(revealArea, item);

          $("selfOkBtn").disabled = false;
          $("selfBadBtn").disabled = false;
        };

        $("selfOkBtn").onclick = () => { score++; next(); };
        $("selfBadBtn").onclick = () => { next(); };

      } else if (mode === "MCQ") {
        const allSameLang = vocab.filter(v => (v.lang||"").toUpperCase() === (item.lang||"").toUpperCase());
        const correct = aText(item);

        const distractors = shuffle(
          allSameLang
            .filter(v => v !== item)
            .map(v => aText(v))
            .filter(t => normalize(t, true) !== normalize(correct, true))
        ).slice(0, 3);

        const choices = shuffle([correct, ...distractors]);

        const wrap = document.createElement("div");
        wrap.className = "choices";

        choices.forEach(ch => {
          const b = document.createElement("button");
          b.textContent = ch;
          b.onclick = () => {
            const ok = normalize(ch, true) === normalize(correct, true);
            if (ok) { b.classList.add("ok"); score++; }
            else { b.classList.add("bad"); }

            [...wrap.querySelectorAll("button")].forEach(x => x.disabled = true);

            const reveal = document.createElement("div");
            reveal.className = "small";
            reveal.style.marginTop = "10px";

            if (ok) reveal.innerHTML = `<span class="pill ok">‚úî richtig</span>`;
            else reveal.innerHTML = `<span class="pill bad">‚úò falsch</span> <span class="mono">Richtig: ${correct}</span>`;

            renderExampleUnder(reveal, item);
            container.appendChild(reveal);
          };
          wrap.appendChild(b);
        });

        container.appendChild(wrap);

        const hint = document.createElement("div");
        hint.className = "small";
        hint.style.marginTop = "8px";
        hint.textContent = "Danach auf ‚ÄûN√§chste‚Äú tippen.";
        container.appendChild(hint);

      } else if (mode === "TYPE") {
        const correct = aText(item);

        const area = document.createElement("div");
        area.className = "answer";
        area.innerHTML = `
          <div class="field">
            <label>Deine Antwort</label>
            <input id="typeInput" placeholder="Antwort eintippen" />
          </div>
          <div class="row">
            <button id="checkBtn" class="btnPrimary" style="width:auto; padding:10px 12px;">Pr√ºfen</button>
            <button id="showBtn">L√∂sung zeigen</button>
          </div>
          <div id="feedback" class="small" style="margin-top:10px;"></div>
        `;
        container.appendChild(area);

        const renderSolutionWithExample = (html) => {
          const fb = $("feedback");
          fb.innerHTML = html;
          renderExampleUnder(fb, item);
        };

        $("checkBtn").onclick = () => {
          const user = $("typeInput").value;
          const ok = normalize(user, lenient) === normalize(correct, lenient);
          if (ok) { score++; }
          renderSolutionWithExample(
            ok
              ? `<span class="pill ok">‚úî richtig</span>`
              : `<span class="pill bad">‚úò falsch</span> <span class="mono">Richtig: ${correct}</span>`
          );
        };

        $("showBtn").onclick = () => {
          renderSolutionWithExample(`<span class="mono">L√∂sung: ${correct}</span>`);
        };

        const hint = document.createElement("div");
        hint.className = "small";
        hint.style.marginTop = "8px";
        hint.textContent = "Danach auf ‚ÄûN√§chste‚Äú tippen.";
        container.appendChild(hint);
      }
    }

    function openOverlay() {
      $("learnOverlay").classList.add("open");
      $("learnOverlay").setAttribute("aria-hidden", "false");
      document.body.classList.add("noscroll");
      syncOverlayButtons();
      renderLearnInner($("learnCardInner"));
      $("learnOverlay").querySelector(".overlayPanel").scrollTop = 0;
    }

    function closeOverlay() {
      $("learnOverlay").classList.remove("open");
      $("learnOverlay").setAttribute("aria-hidden", "true");
      document.body.classList.remove("noscroll");
    }

    function syncOverlayButtons() {
      const can = inSession;
      $("nextBtn2").disabled = !can;
      $("endBtn2").disabled = !can;
    }

    function next() {
      if (!inSession) return;
      if (idx < session.length - 1) {
        idx++;
        renderLearnInner($("learnCardInner"));
      } else {
        inSession = false;
        renderLearnInner($("learnCardInner"));
        syncOverlayButtons();
        status("Session fertig");
        }
    }

    function endSession() {
      inSession = false;
      session = [];
      idx = 0;
      renderLearnInner($("learnCardInner"));
      syncOverlayButtons();
      status("Session beendet");
    }

    // -------------------------
    // CSV table
    // -------------------------
    function renderCsvTable() {
      const host = $("vocabList");
      if (!host) return;
      host.innerHTML = "";
    
      // Neueste zuerst (wie vorher)
      const rows = vocab.slice().sort((a, b) => {
        const ia = Number(a.id);
        const ib = Number(b.id);
        if (!Number.isNaN(ia) && !Number.isNaN(ib)) return ib - ia;
        return String(b.id || "").localeCompare(String(a.id || ""));
      });
    
      for (const it of rows) {
        const d = document.createElement("details");
        d.className = "vocabEntry";
    
        const s = document.createElement("summary");
    
        const w = document.createElement("div");
        w.className = "vocabWord";
        w.textContent = (it.foreign || "").trim() || "‚Äî";
    
        const m = document.createElement("div");
        m.className = "vocabMeta";
        // optional: Sprache anzeigen
        m.textContent = (it.lang || "").toUpperCase();
    
        s.appendChild(w);
        s.appendChild(m);
    
        const body = document.createElement("div");
        body.className = "vocabBody";
    
        const lineDe = document.createElement("div");
        lineDe.className = "vocabLine";
        lineDe.innerHTML = `<span class="k">DE:</span>${(it.de || "‚Äî")}`;
    
        const lineEx = document.createElement("div");
        lineEx.className = "vocabLine";
        const ex = (it.example || "").trim();
        lineEx.innerHTML = ex ? `<span class="k">Beispiel:</span>${ex}` : `<span class="k">Beispiel:</span>‚Äî`;
    
        const lineTags = document.createElement("div");
        lineTags.className = "vocabLine";
        const tags = (it.tags || "").trim();
        lineTags.innerHTML = tags ? `<span class="k">Tags:</span>${tags}` : `<span class="k">Tags:</span>‚Äî`;
    
        body.appendChild(lineDe);
        body.appendChild(lineEx);
        body.appendChild(lineTags);
    
        d.appendChild(s);
        d.appendChild(body);
    
        host.appendChild(d);
      }
    
      $("csvCountLabel").textContent = `${vocab.length} Zeilen`;
    }

    // -------------------------
    // Home labels
    // -------------------------
    function directionLabel(v){
      if (v === "DE_TO_FOREIGN") return "Deutsch ‚Üí Fremdsprache";
      if (v === "FOREIGN_TO_DE") return "Fremdsprache ‚Üí Deutsch";
      return "Beide Richtungen (gemischt)";
    }
    function modeLabel(v){
      if (v === "FLASH") return "Karteikarten (richtig/falsch)";
      if (v === "MCQ") return "Multiple Choice";
      return "Eingabe";
    }

    function updateTopStats() {
      const a = $("statTotal");
      const b = $("statLearned");
      const c = $("statPracticed");
      if (a) a.textContent = String(vocab.length);
      if (b) b.textContent = "0";
      if (c) c.textContent = "0";
    }
    
    function updateLabels() {
      $("labelLang").textContent = (selectedLang === "ALL") ? "Alle Sprachen" : selectedLang;
      $("labelDirection").textContent = directionLabel(direction);
      $("labelMode").textContent = modeLabel(mode);
      $("labelLimit").textContent = (limitN === 0) ? "Alle" : String(limitN);
      $("labelLenient").textContent = lenient ? "an (ignoriert Gro√ü/Klein + Akzente)" : "aus";

      if (selectedTags.size === 0) $("labelTags").textContent = "Alle";
      else if (selectedTags.size === 1) $("labelTags").textContent = [...selectedTags][0];
      else $("labelTags").textContent = `${selectedTags.size} ausgew√§hlt`;

      updateTopStats();
    }

    // -------------------------
    // Modal helpers
    // -------------------------
    let modalOnOk = null;
    let modalOnCancel = null;

    function openModal(title, buildBodyFn, onOkFn, onCancelFn) {
      $("modalTitle").textContent = title;
      const body = $("modalBody");
      body.innerHTML = "";
      buildBodyFn(body);

      modalOnOk = onOkFn || null;
      modalOnCancel = onCancelFn || null;

      $("modal").classList.add("open");
      $("modal").setAttribute("aria-hidden", "false");
      document.body.classList.add("noscroll");
    }

    function closeModal(trigger) {
      $("modal").classList.remove("open");
      $("modal").setAttribute("aria-hidden", "true");
      document.body.classList.remove("noscroll");

      if (trigger === "ok" && typeof modalOnOk === "function") modalOnOk();
      if (trigger === "cancel" && typeof modalOnCancel === "function") modalOnCancel();

      modalOnOk = null;
      modalOnCancel = null;
    }

            $("modalOkBtn").addEventListener("click", () => closeModal("ok"));

    // -------------------------
    // Option modals
    // -------------------------
    function openLangModal() {
      const langs = getAllLangs();
      let temp = selectedLang;

      openModal(
        "Sprache",
        (body) => {
          const wrap = document.createElement("div");
          wrap.className = "field";
          wrap.innerHTML = `<label>Sprache ausw√§hlen</label>`;
          const sel = document.createElement("select");

          const oAll = document.createElement("option");
          oAll.value = "ALL";
          oAll.textContent = "Alle Sprachen";
          sel.appendChild(oAll);

          langs.forEach(l => {
            const o = document.createElement("option");
            o.value = l;
            o.textContent = l;
            sel.appendChild(o);
          });

          sel.value = temp;
          sel.onchange = () => { temp = sel.value; };

          wrap.appendChild(sel);
          body.appendChild(wrap);

          const note = document.createElement("div");
          note.className = "small";
          note.textContent = "Filter wirkt bei neuer Session.";
          body.appendChild(note);
        },
        () => { selectedLang = temp; updateLabels(); status(inSession ? "Session l√§uft (√Ñnderung wirkt erst bei neuer Session)" : "bereit"); },
        null
      );
    }

    function openDirectionModal() {
      let temp = direction;
      openModal(
        "Richtung",
        (body) => {
          const wrap = document.createElement("div");
          wrap.className = "field";
          wrap.innerHTML = `<label>Richtung ausw√§hlen</label>`;
          const sel = document.createElement("select");
          [
            ["DE_TO_FOREIGN","Deutsch ‚Üí Fremdsprache"],
            ["FOREIGN_TO_DE","Fremdsprache ‚Üí Deutsch"],
            ["BOTH","Beide Richtungen (gemischt)"]
          ].forEach(([v,t]) => {
            const o = document.createElement("option");
            o.value = v; o.textContent = t;
            sel.appendChild(o);
          });
          sel.value = temp;
          sel.onchange = () => { temp = sel.value; };
          wrap.appendChild(sel);
          body.appendChild(wrap);

          const expl = document.createElement("div");
          expl.className = "small";
          expl.innerHTML = "‚Ä¢ <span class=\"mono\">aus</span>: Deine Eingabe muss exakt passen.<br>‚Ä¢ <span class=\"mono\">an</span>: Gro√ü/Klein und Akzente werden ignoriert (z.&nbsp;B. \"caf√©\" = \"Cafe\").";
          body.appendChild(expl);
        },
        () => { direction = temp; updateLabels(); status(inSession ? "Session l√§uft (√Ñnderung wirkt erst bei neuer Session)" : "bereit"); },
        null
      );
    }

    function openModeModal() {
      let temp = mode;
      openModal(
        "Modus",
        (body) => {
          const wrap = document.createElement("div");
          wrap.className = "field";
          wrap.innerHTML = `<label>Modus ausw√§hlen</label>`;
          const sel = document.createElement("select");
          [
            ["FLASH","Karteikarten (richtig/falsch)"],
            ["MCQ","Multiple Choice"],
            ["TYPE","Eingabe"]
          ].forEach(([v,t]) => {
            const o = document.createElement("option");
            o.value = v; o.textContent = t;
            sel.appendChild(o);
          });
          sel.value = temp;
          sel.onchange = () => { temp = sel.value; };
          wrap.appendChild(sel);
          body.appendChild(wrap);

          const note = document.createElement("div");
          note.className = "small";
          note.textContent = "Filter wirkt bei neuer Session.";
          body.appendChild(note);
        },
        () => { mode = temp; updateLabels(); status(inSession ? "Session l√§uft (√Ñnderung wirkt erst bei neuer Session)" : "bereit"); },
        null
      );
    }

    function openLimitModal() {
      let temp = (limitN === 0) ? "0" : String(limitN);
    
      openModal(
        "Anzahl Fragen",
        (body) => {
          const wrap = document.createElement("div");
          wrap.className = "field";
          wrap.innerHTML = `<label>Anzahl ausw√§hlen</label>`;
    
          const sel = document.createElement("select");
          [
            ["0", "Unbegrenzt"],
            ["25", "25"],
            ["50", "50"],
            ["75", "75"],
            ["100", "100"]
          ].forEach(([v, t]) => {
            const o = document.createElement("option");
            o.value = v;
            o.textContent = t;
            sel.appendChild(o);
          });
    
          sel.value = temp;
          sel.onchange = () => { temp = sel.value; };
    
          wrap.appendChild(sel);
          body.appendChild(wrap);
    
          const note = document.createElement("div");
          note.className = "small";
          note.textContent = "Die Einstellung wirkt bei neuer Session.";
          body.appendChild(note);
        },
        () => {
          const n = Number(temp);
          limitN = (!Number.isFinite(n) || n <= 0) ? 0 : n;
          updateLabels();
          status(inSession ? "Session l√§uft (√Ñnderung wirkt erst bei neuer Session)" : "bereit");
        },
        null
      );
    }

    function openLenientModal() {
      let temp = lenient;
      openModal(
        "Akzente & Gro√ü/klein ignorieren",
        (body) => {
          const wrap = document.createElement("div");
          wrap.className = "field";
          wrap.innerHTML = `<label>Gro√ü/Klein & Akzente ignorieren (nur Eingabe)</label>`;
          const sel = document.createElement("select");
          const o1 = document.createElement("option"); o1.value="OFF"; o1.textContent="aus";
          const o2 = document.createElement("option"); o2.value="ON"; o2.textContent="an";
          sel.appendChild(o1); sel.appendChild(o2);
          sel.value = temp ? "ON" : "OFF";
          sel.onchange = () => { temp = sel.value === "ON"; };
          wrap.appendChild(sel);
          body.appendChild(wrap);
        },
        () => { lenient = temp; updateLabels(); status(inSession ? "Session l√§uft (√Ñnderung wirkt erst bei neuer Session)" : "bereit"); },
        null
      );
    }

    function selectTagsByRecencyInSet(tagLatest, days, set) {
      const cutoff = new Date();
      cutoff.setDate(cutoff.getDate() - days);
      for (const [t, d] of tagLatest.entries()) {
        if ((d || new Date(0)) >= cutoff) set.add(t);
      }
    }

    function openTagsModal() {
      const tagLatest = computeTagRecency();
      const sortedTags = [...tagLatest.keys()].sort((a,b) => {
        const da = tagLatest.get(a) || new Date(0);
        const db = tagLatest.get(b) || new Date(0);
        if (db.getTime() !== da.getTime()) return db - da;  // neueste oben
        return a.localeCompare(b, "de");
      });

      // temp copy
      const temp = new Set(selectedTags);

      openModal(
        "Units/Tags",
        (body) => {
          const quick = document.createElement("div");
          quick.className = "row";
          quick.style.gap = "10px";
          quick.innerHTML = `
            <button id="t30">letzte 30 Tage</button>
            <button id="t90">letzte 90 Tage</button>
            <button id="tAll">alle</button>
            <button id="tNone">keine</button>
          `;
          body.appendChild(quick);

          const list = document.createElement("div");
          list.className = "tagList";

          function renderList() {
            list.innerHTML = "";
            sortedTags.forEach(t => {
              const d = tagLatest.get(t) || new Date(0);
              const row = document.createElement("div");
              row.className = "tagRow";

              const cb = document.createElement("input");
              cb.type = "checkbox";
              cb.checked = temp.has(t);
              cb.onchange = () => {
                if (cb.checked) temp.add(t);
                else temp.delete(t);
              };

              const name = document.createElement("div");
              name.className = "name";
              name.textContent = t;

              const date = document.createElement("div");
              date.className = "date";
              date.textContent = tagDateStr(d);

              row.appendChild(cb);
              row.appendChild(name);
              row.appendChild(date);

              row.addEventListener("click", (e) => {
                if (e.target === cb) return;
                cb.checked = !cb.checked;
                cb.dispatchEvent(new Event("change"));
              });

              list.appendChild(row);
            });
          }

          renderList();
          body.appendChild(list);

          // wire quick buttons
          $("t30").onclick = () => { temp.clear(); selectTagsByRecencyInSet(tagLatest, 30, temp); renderList(); };
          $("t90").onclick = () => { temp.clear(); selectTagsByRecencyInSet(tagLatest, 90, temp); renderList(); };
          $("tAll").onclick = () => { temp.clear(); sortedTags.forEach(t => temp.add(t)); renderList(); };
          $("tNone").onclick = () => { temp.clear(); renderList(); };

          const note = document.createElement("div");
          note.className = "small";
          note.textContent = "Sortierung: neueste Units oben (nach Added-Datum). Filter wirkt bei neuer Session.";
          body.appendChild(note);
        },
        () => { selectedTags = temp; updateLabels(); status(inSession ? "Session l√§uft (√Ñnderung wirkt erst bei neuer Session)" : "bereit"); },
        null
      );
    }

    // -------------------------
    // Wiring
    // -------------------------
    $("closeOverlayBtn").addEventListener("click", closeOverlay);
    $("nextBtn2").addEventListener("click", next);
    $("endBtn2").addEventListener("click", endSession);

    $("startBtn").addEventListener("click", () => {
      if (vocab.length === 0) return alert("Keine Vokabeln vorhanden.");
      const ok = buildSession();
      if (!ok) return alert("Keine passenden Vokabeln f√ºr deine Filter (Sprache/Tags).");
      inSession = true;
      syncOverlayButtons();
      status("Session l√§uft");
      openOverlay();
    });

    // Open modals
    $("pickLang").addEventListener("click", openLangModal);
    $("pickDirection").addEventListener("click", openDirectionModal);
    $("pickMode").addEventListener("click", openModeModal);
    $("pickLimit").addEventListener("click", openLimitModal);
    $("pickLenient").addEventListener("click", openLenientModal);
    $("pickTags").addEventListener("click", openTagsModal);

    // -------------------------
    // INIT
    // -------------------------
    async function init() {
      $("csvLabel").textContent = CSV_URL;
      $("startBtn").disabled = true;

      // defaults on labels
      updateLabels();
      updateTopStats();

      try {
        status("lade CSV‚Ä¶");
        const r = await fetch(CSV_URL, { cache: "no-store" });
        if (!r.ok) throw new Error("CSV not found");
        const text = await r.text();
        const items = fromCsv(text);

        vocab = items
          .filter(it => (it.de || it.foreign) && (it.lang || "").trim())
          .map(it => ({
            id: (it.id || "").toString().trim(),
            added: (it.added || "").trim(),
            de: (it.de || "").trim(),
            foreign: (it.foreign || "").trim(),
            lang: (it.lang || "EN").toUpperCase().trim(),
            tags: (it.tags || "").trim(),
            example: (it.example || "").trim()
          }))
          .filter(it => it.de && it.foreign);

        renderCsvTable();

        $("csvCountLabel").textContent = `${vocab.length} Zeilen`;
        $("startBtn").disabled = vocab.length === 0;

        updateLabels();
        status(vocab.length ? "bereit" : "CSV leer");
      } catch (e) {
        vocab = [];
        renderCsvTable();
        updateLabels();
        status(`Keine CSV gefunden: ${CSV_URL}`);
        $("startBtn").disabled = true;
      }
    }

    init();
  </script>
</body>
</html>
