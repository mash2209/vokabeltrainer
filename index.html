<!DOCTYPE html>

<html lang="de">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<title>Vokabeltrainer</title>
<style>
    :root{
      --gap: 12px;
        
      --bg1:#f6f3ff;
      --bg2:#eef2ff;

      --card:#ffffff;
      --text:#0f172a;
      --muted:#64748b;

      --itemBg: rgba(251, 191, 36, 0.12) ;

      --line: rgba(15,23,42,.08);
      --shadow1: 0 10px 30px rgba(15,23,42,.08);
      --shadow2: 0 2px 12px rgba(15,23,42,.06);

      --r20: 20px;
      --r18: 18px;
      --r16: 16px;
      --r14: 14px;
      --r12: 12px;

      --primaryA:#2563eb;
      --primaryB:#7c3aed;

      --ctaA:#ea580c;
      --ctaB:#fbbf24;

      --okBorder:#bfe5c9;
      --okBg:#f2fbf4;
      --badBorder:#f0c0c6;
      --badBg:#fff7f8;
    }

    *{ box-sizing: border-box; }
    html, body { max-width: 100%; overflow-x: hidden; }

    body{
      margin:0;
      font-family: -apple-system, system-ui, Segoe UI, Roboto, Arial, sans-serif;
      color: var(--text);
      background:
        radial-gradient(1000px 500px at 50% 0%, var(--bg1), transparent 60%),
        radial-gradient(900px 600px at 40% 30%, var(--bg2), transparent 60%),
        #f7f7fb;
    }

    main{
      width:100%;
      max-width: 460px;
      margin: 22px auto;
      padding: 0 14px 22px;
      display:grid;
      gap: 14px;
    }

    .card{
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: var(--r20);
      box-shadow: var(--shadow2);
      padding: 14px;
    }

    .row{ display:flex; align-items:center; gap: var(--gap); flex-wrap: wrap; }
    .stack{ display:grid; gap: 10px; }

    .small{ font-size:12px; color: var(--muted); }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; }
    .big{ font-size: 20px; font-weight: 900; line-height: 1.25; }
    .right{ margin-left:auto; }

    .appTitle{
      display:flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      font-weight: 900;
      font-size: 22px;
      color:#5b21b6;
      margin: 4px 0 10px;
    }
    .spark{
      width:20px;height:20px;
      display:inline-grid; place-items:center;
      color:#7c3aed;
    }

    .sparkTop{
      align-self: flex-start;
      transform: translateY(-4px);
    }

    .sparkMid{
      align-self: center;
    }

    .sparkBot{
      align-self: flex-end;
      transform: translateY(4px);
    }
    
    /* Stats */
    .stats{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      margin-bottom: 12px;
    }
    .stat{
      background:#fff;
      border: 1px solid var(--line);
      border-radius: var(--r18);
      padding: 10px;
      box-shadow: 0 1px 0 rgba(0,0,0,0.02);
    }
    .stat .num{ font-size: 20px; font-weight: 900; line-height:1; }
    .stat .lbl{ font-size: 12px; color: var(--muted); margin-top: 4px; }

    /* Controls */
    button, select, input { font: inherit; }
    button{
      border: 1px solid rgba(15,23,42,.12);
      background: #fff;
      padding: 10px 12px;
      border-radius: var(--r16);
      cursor: pointer;
      box-shadow: 0 1px 0 rgba(0,0,0,0.02);
    }
    button:disabled{ opacity:.55; cursor:not-allowed; }
    button.danger{
      background:#fff;
      color:#b00020;
      border-color: rgba(176,0,32,.18);
    }
    .btnPrimary{
      width:100%;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      border: 0;
      padding: 12px 14px;
      border-radius: var(--r18);
      color:#fff;
      font-weight: 900;
      background: linear-gradient(90deg, var(--ctaB), var(--ctaA));
      box-shadow: var(--shadow1);
    }

    /* List items */
    .item{
      display:flex;
      align-items:center;
      gap: 12px;
      padding: 12px 12px;
      border-radius: var(--r18);
      border: 1px solid var(--line);
      background: var(--itemBg);
      box-shadow: 0 1px 0 rgba(0,0,0,0.02);
      cursor: pointer;
    }
    .item:active{ transform: translateY(1px); }
    .ic{
      width: 32px; height: 32px;
      border-radius: 999px;
      display:grid; place-items:center;
      background: rgba(124,58,237,.12);
      color:#7c3aed;
      flex: 0 0 auto;
      font-weight: 900;
    }
    .txt{ display:grid; min-width: 0; }
    .txt strong{ font-size: 14px; }
    .txt span{ font-size: 12px; color: var(--muted); margin-top:2px; }
    .chev{ margin-left:auto; color: rgba(15,23,42,.35); font-size: 20px; }

    .sectionLbl{
      display:flex;
      align-items:center;
      gap: 8px;
      color: rgba(15,23,42,.75);
      font-weight: 900;
      font-size: 13px;
      margin-top: 10px;
      margin-bottom: 2px;
    }
    .mini{
      width:18px;height:18px;
      display:grid; place-items:center;
      color:#f59e0b;
    }

    /* Pills */
    .pill{
      display:inline-flex;
      align-items:center;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.72);
      font-size: 12px;
      color: rgba(15,23,42,.85);
    }

    /* Learn overlay */
    .overlay{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.35);
      display: none;
      z-index: 999;
    }
    .overlay.open{ display:block; }
    .overlayPanel{
      position:absolute;
      inset: 10px;
      background: rgba(247,247,251,1);
      border-radius: var(--r20);
      padding: 10px;
      overflow:auto;
      border: 1px solid rgba(255,255,255,.55);
      box-shadow: var(--shadow1);
    }
    body.noscroll{ overflow:hidden; }

    .answer{
      padding: 12px;
      border: 1px dashed rgba(15,23,42,.18);
      border-radius: var(--r18);
      background: rgba(255,255,255,.75);
      margin-top: 10px;
    }
    .choices{ display:grid; gap: 8px; margin-top: 10px; }
    .choices button{ text-align:left; }

    .ok{ border-color: var(--okBorder) !important; background: var(--okBg) !important; }
    .bad{ border-color: var(--badBorder) !important; background: var(--badBg) !important; }

    /* Modal (Pop-up Auswahl) */
    .modal{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.35);
      display:none;
      z-index: 1000;
    }
    .modal.open{ display:block; }
    .modalPanel{
      position: absolute;
      left: 10px; right: 10px; bottom: 10px;
      background: #fff;
      border-radius: var(--r20);
      border: 1px solid var(--line);
      box-shadow: var(--shadow1);
      overflow: hidden;
      max-height: calc(100vh - 20px);
      display:flex;
      flex-direction: column;
    }
    .modalHead{
      padding: 12px 12px;
      display:flex;
      align-items:center;
      gap: 10px;
      border-bottom: 1px solid var(--line);
      background: rgba(255,255,255,.9);
    }
    .modalHead strong{ font-size: 14px; }
    .modalBody{
      padding: 12px;
      overflow:auto;
      display:grid;
      gap: 10px;
    }
    .modalFoot{
      padding: 12px;
      border-top: 1px solid var(--line);
      display:flex;
      gap: 10px;
      justify-content:flex-end;
      background: rgba(255,255,255,.9);
    }
    .field{
      display:grid;
      gap: 6px;
    }
    .field label{
      font-size: 12px;
      color: rgba(15,23,42,.8);
      font-weight: 800;
    }
    .field select, .field input{
      width:100%;
      padding: 10px;
      border-radius: var(--r16);
      border: 1px solid var(--line);
      background:#fff;
      outline:none;
    }

    /* Tags list */
    .tagList{
      display:grid;
      gap: 8px;
    }
    .tagRow{
      display:flex;
      align-items:center;
      gap: 10px;
      padding: 10px 10px;
      border: 1px solid var(--line);
      border-radius: var(--r16);
      background: #fff;
    }
    .tagRow input[type="checkbox"]{ width:18px; height:18px; }
    .tagRow .name{ font-weight: 900; font-size: 13px; }
    .tagRow .date{ margin-left:auto; font-size: 12px; color: var(--muted); }

    /* CSV */
    details.csvBlock summary{
      list-style:none;
      cursor:pointer;
      user-select:none;
      display:flex;
      align-items:center;
      gap: 10px;
      font-weight: 900;
      font-size: 13px;
      color: rgba(15,23,42,.85);
    }
    details.csvBlock summary::-webkit-details-marker{ display:none; }

    .tableWrap{
      overflow:auto;            /* horizontal + vertical inside */
      border: 1px solid var(--line);
      border-radius: var(--r18);
      background: #fff;
      max-height: 280px;
      margin-top: 10px;
    }
    table.csv{
      border-collapse: collapse;
      width: max-content;
      min-width: 100%;
    }
    table.csv th, table.csv td{
      border-bottom: 1px solid rgba(15,23,42,.06);
      padding: 7px 9px;
      white-space: nowrap;
      font-size: 11px;          /* deutlich kleiner */
      vertical-align: top;
    }
    table.csv th{
      position: sticky;
      top: 0;
      background: #fbfcfe;
      text-align: left;
      color: rgba(15,23,42,.7);
    }
    
    .vocabSearchRow{
      margin-top: 10px;
    }
    .vocabSearch{
      width: 100%;
      padding: 10px 12px;
      border-radius: var(--r16);
      border: 1px solid var(--line);
      background: #fff;
      outline: none;
    }
    .vocabSearch::placeholder{
      color: rgba(100,116,139,.9);
    }

    .vocabList{
      display:grid;
      gap: 10px;
      margin-top: 10px;
    }
    
    .vocabEntry{
      border: 1px solid var(--line);
      border-radius: var(--r18);
      background:#fff;
      overflow:hidden;
    }
    
    .vocabEntry summary{
      list-style:none;
      cursor:pointer;
      user-select:none;
      padding: 12px 12px;
      display:flex;
      align-items:center;
      gap: 10px;
    }
    
    .vocabEntry summary::-webkit-details-marker{ display:none; }
    
    .vocabWord{
      font-weight: 900;
      font-size: 15px;
      line-height: 1.2;
      overflow:hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    
    .vocabMeta{
      margin-left:auto;
      font-size: 12px;
      color: var(--muted);
      flex: 0 0 auto;
    }
    
    .vocabBody{
      padding: 0 12px 12px;
      display:grid;
      gap: 8px;
    }
    
    .vocabLine{
      font-size: 13px;
      color: rgba(15,23,42,.9);
      word-break: break-word;   /* bleibt in der Breite */
    }
    
    .vocabLine .k{
      font-size: 12px;
      color: var(--muted);
      font-weight: 800;
      margin-right: 6px;
    }
    
    /* Card 3: dunklere Variante des Primary Buttons */
    .btnLearn{
      background: linear-gradient(90deg, #f59e0b, #c2410c); /* etwas dunkler als CTA */
    }
    
    /* Card 3: zuletzt gelernt (Pills) */
    .learnPills{
      display:flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    
    .learnPillBtn{
      border: 1px solid var(--line);
      background: rgba(255,255,255,.85);
      border-radius: 999px;
      padding: 8px 10px;
      font-size: 12px;
      font-weight: 900;
      cursor: pointer;
    }
    
    .learnPillBtn:disabled{
      opacity:.55;
      cursor:not-allowed;
    }
    
    .learnList{
      display:grid;
      gap: 8px;
    }
    
    .learnRow{
      border: 1px solid var(--line);
      border-radius: var(--r16);
      background: #fff;
      padding: 10px 10px;
    
      display:grid;
      grid-template-columns: 1fr 1fr;
      column-gap: 12px;
    }
    
    .learnRow .f{
      font-weight: 900;
      font-size: 13px;
      line-height: 1.2;
      overflow-wrap: anywhere;
    }
    
    .learnRow .d{
      font-size: 12px;
      color: rgba(15,23,42,.75);
      overflow-wrap: anywhere;
    }

    .learnRow .ex{
      grid-column: 1 / -1;   /* √ºber beide Spalten */
      margin-top: 6px;
      font-size: 12px;
      color: rgba(15,23,42,.6);
      overflow-wrap: anywhere;
    }

    .learnRow .meta{
      margin-top: 6px;
      font-size: 11px;
      color: var(--muted);
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .btnOk{
      border: 1px solid rgba(34,197,94,.25);
      color: #065f46;
      font-weight: 900;
      background: linear-gradient(90deg,
        rgba(134,239,172,.75),
        rgba(187,247,208,.75)
      );
      box-shadow: 0 2px 10px rgba(34,197,94,.12);
    }
    
    .btnBad{
      border: 1px solid rgba(244,63,94,.22);
      color: #9f1239;
      font-weight: 900;
      background: linear-gradient(90deg,
        rgba(253,164,175,.75),
        rgba(254,205,211,.75)
      );
      box-shadow: 0 2px 10px rgba(244,63,94,.10);
    }
    
    .btnOk:disabled,
    .btnBad:disabled{
      opacity: .55;
      cursor: not-allowed;
      box-shadow: none;
    }

  </style>
</head>
<body>
<!-- Lern-Overlay -->
<div aria-hidden="true" class="overlay" id="learnOverlay">
<div class="overlayPanel">
<div class="row" style="margin-bottom: 10px;">
<strong>Lernen</strong>
<button disabled="" id="nextBtn2">N√§chste</button>
<button class="danger" disabled="" id="endBtn2">Beenden</button>
</div>
<div id="learnCardInner"></div>
</div>
</div>
<!-- Auswahl-Modal -->
<div aria-hidden="true" class="modal" id="modal">
<div aria-modal="true" class="modalPanel" role="dialog">
<div class="modalHead">
<strong id="modalTitle">Auswahl</strong>
<span class="right"></span>

</div>
<div class="modalBody" id="modalBody"></div>
<div class="modalFoot">
  <button id="modalCancelBtn">Abbrechen</button>
  <button class="btnPrimary" id="modalGoBtn" style="width:auto; padding:10px 12px;" disabled>Los geht's</button>
</div>
</div>
</div>
<main>
  <!-- Card 1: Nur √úberschrift -->
  <section class="card">
    <div class="appTitle">
      <span>Vokabeltrainer</span>
      <span class="spark sparkBot">‚ú¶</span>
      <span class="spark sparkMid">‚ú¶</span>
      <span class="spark sparkTop">‚ú¶</span>
    </div>
  </section>

  <!-- Card 2: Session (wie bisher, nur ohne √úberschrift) -->
  <section class="card">
    <button class="btnPrimary" disabled="" id="startBtn">Session starten</button>

    <div class="stack" style="margin-top:12px;">
      <div class="item" id="pickLang">
        <div class="ic" style="background: rgba(15,23,42,.06); color:#0f172a;">üåê</div>
        <div class="txt">
          <strong>Sprache</strong>
          <span id="labelLang">‚Äî</span>
        </div>
        <div class="chev">‚Ä∫</div>
      </div>

      <div class="item" id="pickDirection">
        <div class="ic" style="background: rgba(37,99,235,.12); color:#2563eb;">‚áÑ</div>
        <div class="txt">
          <strong>Richtung</strong>
          <span id="labelDirection">‚Äî</span>
        </div>
        <div class="chev">‚Ä∫</div>
      </div>

      <div class="item" id="pickMode">
        <div class="ic" style="background: rgba(124,58,237,.12); color:#7c3aed;">üß©</div>
        <div class="txt">
          <strong>Modus</strong>
          <span id="labelMode">‚Äî</span>
        </div>
        <div class="chev">‚Ä∫</div>
      </div>

      <div class="item" id="pickLimit">
        <div class="ic" style="background: rgba(245,158,11,.14); color:#b45309;">#</div>
        <div class="txt">
          <strong>Anzahl Fragen</strong>
          <span id="labelLimit">‚Äî</span>
        </div>
        <div class="chev">‚Ä∫</div>
      </div>

      <div class="item" id="pickLenient">
        <div class="ic" style="background: rgba(15,23,42,.06); color:#0f172a;">Aa</div>
        <div class="txt">
          <strong>Akzente & Gro√ü/klein ignorieren</strong>
          <span id="labelLenient">‚Äî</span>
        </div>
        <div class="chev">‚Ä∫</div>
      </div>

      <div class="item" id="pickTags">
        <div class="ic" style="background: rgba(124,58,237,.12); color:#7c3aed;">üè∑</div>
        <div class="txt">
          <strong>Units/Tags</strong>
          <span id="labelTags">‚Äî</span>
        </div>
        <div class="chev">‚Ä∫</div>
      </div>

      <div class="small">CSV: <span class="mono" id="csvLabel"></span></div>
    </div>
  </section>

  <!-- Card 3: Vokabeln lernen (Startseite) -->
  <section class="card" id="learnCard">
    <button class="btnPrimary btnLearn" disabled id="learnStartBtn">Vokabeln lernen</button>

    <div class="sectionLbl" style="margin-top:12px;">
      <span class="mini">üè∑</span>
      <span>Zuletzt gelernt</span>
    </div>

    <div id="recentLearnTags" class="learnPills" style="margin-top:8px;"></div>

    <div class="small" style="margin-top:10px;">
      Tipp: Klicke eine Unit/Tag an, um direkt zur Lerntabelle zu springen.
    </div>
  </section>

  <!-- Card 4: CSV bleibt -->
  <section class="card">
    <details class="csvBlock" id="csvDetails">
      <summary>
        <span>Vokabeltabelle anzeigen</span>
        <span class="right small" id="csvCountLabel"></span>
      </summary>

      <div class="vocabSearchRow">
        <input id="vocabSearch" class="vocabSearch" type="search" placeholder="Vokabel suchen (Fremdsprache oder Deutsch) ‚Ä¶">
      </div>

      <div id="vocabList" class="vocabList"></div>
      <div class="small" style="margin-top:8px;">
        Read-only Anzeige der CSV-Daten
      </div>
    </details>
  </section>
</main>
<script>
    function getListKey() {
      const p = new URLSearchParams(location.search);
      return (p.get("list") || "default").trim().toLowerCase();
    }
    const LIST_KEY = getListKey();
    const CSV_URL = `csv/vocab_${LIST_KEY}.csv`;
    const LS_LEARN_TAGS_KEY = `vocab_learn_last_tags_${LIST_KEY}`;

    let vocab = [];
    let APP_STATE = null;

    // =========================
    // STORAGE (Root per LIST_KEY)
    // =========================
    function stateKey(listKey) {
      return `vocab_state_${(listKey || "default").trim().toLowerCase()}`;
    }
    
    const SCHEMA_VERSION = 1;
    
    function nowTs() { return Date.now(); }
    
    function makeEmptyVocabState() {
      return {
        score: 0,
        seen: 0,
        correct: 0,
        wrong: 0,
        byMode: {
          FLASH: { seen: 0, correct: 0, wrong: 0 },
          MCQ:   { seen: 0, correct: 0, wrong: 0 },
          TYPE:  { seen: 0, correct: 0, wrong: 0 }
        },
        lastSeenAt: 0,
        decayStage: 0
      };
    }
    
    function makeDefaultRootState() {
      return {
        schemaVersion: SCHEMA_VERSION,
        updatedAt: 0,
        vocabById: {},
        challengesByTag: {},
        prefs: {
          selectedLang: "ALL",
          direction: "DE_TO_FOREIGN",
          mode: "FLASH",
          limitN: 0,
          lenient: false,
          selectedTags: [],
          recentLearnTags: [],
          lastBackupPromptAt: 0,
          lastExportAt: 0
        }
      };
    }
    
    function loadRootState() {
      const key = stateKey(LIST_KEY);
      const raw = localStorage.getItem(key);
      if (!raw) return makeDefaultRootState();
    
      try {
        const parsed = JSON.parse(raw);
    
        if (!parsed || typeof parsed !== "object") return makeDefaultRootState();
        // schemaVersion sp√§ter f√ºr Migration nutzen ‚Äì hier erstmal tolerant
    
        const d = makeDefaultRootState();
        return {
          ...d,
          ...parsed,
          vocabById: parsed.vocabById && typeof parsed.vocabById === "object" ? parsed.vocabById : {},
          challengesByTag: parsed.challengesByTag && typeof parsed.challengesByTag === "object" ? parsed.challengesByTag : {},
          prefs: { ...d.prefs, ...(parsed.prefs || {}) }
        };
      } catch {
        return makeDefaultRootState();
      }
    }
    
    function saveRootState(state) {
      state.updatedAt = nowTs();
      const key = stateKey(LIST_KEY);
      localStorage.setItem(key, JSON.stringify(state));
    }
    
    function ensureVocabStatesFromCsv(state, vocabItems) {
      if (!state.vocabById) state.vocabById = {};
    
      for (const it of vocabItems) {
        const id = (it.id || "").toString().trim();
        if (!id) continue;
    
        if (!state.vocabById[id]) {
          state.vocabById[id] = makeEmptyVocabState();
        } else {
          const base = makeEmptyVocabState();
          const cur = state.vocabById[id] || {};
          state.vocabById[id] = {
            ...base,
            ...cur,
            byMode: {
              ...base.byMode,
              ...(cur.byMode || {}),
              FLASH: { ...base.byMode.FLASH, ...(cur.byMode?.FLASH || {}) },
              MCQ:   { ...base.byMode.MCQ,   ...(cur.byMode?.MCQ   || {}) },
              TYPE:  { ...base.byMode.TYPE,  ...(cur.byMode?.TYPE  || {}) }
            }
          };
          if (!Number.isFinite(state.vocabById[id].score) || state.vocabById[id].score < 0) {
            state.vocabById[id].score = 0;
          }
        }
      }
    }

    // =========================
    // SCORE UPDATE (ohne Decay)
    // =========================
    function clampScore(x) {
      return Math.max(0, Number.isFinite(x) ? x : 0);
    }
    
    function getVocabStateForId(id) {
      if (!APP_STATE) return null;
      if (!APP_STATE.vocabById) APP_STATE.vocabById = {};
      if (!APP_STATE.vocabById[id]) APP_STATE.vocabById[id] = makeEmptyVocabState();
      return APP_STATE.vocabById[id];
    }
    
    function applyAnswerScore(id, mode, isCorrect) {
      const s = getVocabStateForId(id);
      if (!s) return;
    
      const m = (mode || "FLASH").toUpperCase();
    
      let delta = 0;
      if (m === "MCQ")  delta = isCorrect ? 0.5 : -0.25;
      if (m === "TYPE") delta = isCorrect ? 2.0 : -1.0;
      if (m === "FLASH") delta = isCorrect ? 1.0 : -0.5;
    
      s.score = clampScore((s.score || 0) + delta);
    
      s.seen = (s.seen || 0) + 1;
      if (isCorrect) s.correct = (s.correct || 0) + 1;
      else s.wrong = (s.wrong || 0) + 1;
    
      if (!s.byMode) s.byMode = makeEmptyVocabState().byMode;
      if (!s.byMode[m]) s.byMode[m] = { seen: 0, correct: 0, wrong: 0 };
    
      s.byMode[m].seen = (s.byMode[m].seen || 0) + 1;
      if (isCorrect) s.byMode[m].correct = (s.byMode[m].correct || 0) + 1;
      else s.byMode[m].wrong = (s.byMode[m].wrong || 0) + 1;
    
      s.lastSeenAt = Date.now();
      s.decayStage = 0;
    
      if (APP_STATE) saveRootState(APP_STATE);
    }
    
    const DAY = 24 * 60 * 60 * 1000;
    
    function applyDecayIfNeededForId(id) {
      const s = getVocabStateForId(id);
      if (!s) return;
    
      const now = Date.now();
      const last = Number(s.lastSeenAt || 0);
    
      if (!last || last <= 0) return;
    
      const age = now - last;
    
      if (age >= 90 * DAY) {
        if ((s.score || 0) !== 0 || (s.decayStage || 0) !== 4) {
          s.score = 0;
          s.decayStage = 4;
          saveRootState(APP_STATE);
        }
        return;
      }
    
      let stage = Number(s.decayStage || 0);
    
      if (age >= 42 * DAY && stage < 3) {
        s.score = clampScore((s.score || 0) - 0.75);
        stage = 3;
      }
    
      if (age >= 21 * DAY && stage < 2) {
        s.score = clampScore((s.score || 0) - 0.5);
        stage = 2;
      }
    
      if (age >= 7 * DAY && stage < 1) {
        s.score = clampScore((s.score || 0) - 0.25);
        stage = 1;
      }
    
      if (stage !== (s.decayStage || 0)) {
        s.decayStage = stage;
        saveRootState(APP_STATE);
      }
    }
    
    function getCategoryFromScore(score) {
      const s = Number(score) || 0;
      if (s <= 1.5) return 1;
      if (s <= 3.5) return 2;
      return 3;
    }
    
    let selectedLang = "ALL";
    let direction = "DE_TO_FOREIGN";
    let mode = "FLASH";
    let limitN = 0;
    let lenient = false;
    let selectedTags = new Set();

    let session = [];
    let idx = 0;
    let score = 0;
    let inSession = false;
    let currentDirForQuestion = "DE_TO_FOREIGN";
    let vocabSearchQuery = "";

    const $ = (id) => document.getElementById(id);

    function parseISODate(s) {
      if (!s) return null;
      const m = /^(\d{4})-(\d{2})-(\d{2})$/.exec(s.trim());
      if (!m) return null;
      const d = new Date(`${m[1]}-${m[2]}-${m[3]}T00:00:00`);
      return isNaN(d.getTime()) ? null : d;
    }

    function normalize(str, isLenient=true) {
      if (!str) return "";
      let s = str.trim();
      if (isLenient) {
        s = s.toLowerCase();
        s = s.normalize("NFD").replace(/[\u0300-\u036f]/g, "");
      }
      s = s.replace(/\s+/g, " ");
      return s;
    }

    function parseTags(tags) {
      return (tags || "")
        .split(";")
        .map(t => t.trim())
        .filter(Boolean);
    }

    function shuffle(a) {
      for (let i = a.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [a[i], a[j]] = [a[j], a[i]];
      }
      return a;
    }

    // -------------------------
    // CSV parser
    // -------------------------
    function fromCsv(text) {
      const rows = [];
      let i = 0, field = "", row = [], inQuotes = false;

      function pushField() { row.push(field); field = ""; }
      function pushRow() { rows.push(row); row = []; }

      while (i < text.length) {
        const c = text[i];
        if (inQuotes) {
          if (c === '"') {
            if (text[i+1] === '"') { field += '"'; i += 2; continue; }
            inQuotes = false; i++; continue;
          } else { field += c; i++; continue; }
        } else {
          if (c === '"') { inQuotes = true; i++; continue; }
          if (c === ',') { pushField(); i++; continue; }
          if (c === '\n') { pushField(); pushRow(); i++; continue; }
          if (c === '\r') { i++; continue; }
          field += c; i++; continue;
        }
      }
      pushField();
      if (row.length > 1 || (row[0] ?? "").trim() !== "") pushRow();
      if (rows.length === 0) return [];

      const header = rows[0].map(h => (h ?? "").trim().toLowerCase());
      const dataRows = rows.slice(1);
      const ix = (name) => header.indexOf(name);

      const idxMap = {
        id: ix("id"),
        added: ix("added"),
        de: ix("de"),
        foreign: ix("foreign"),
        lang: ix("lang"),
        tags: ix("tags"),
        example: ix("example")
      };

      const out = [];
      for (const r of dataRows) {
        const get = (k) => {
          const j = idxMap[k];
          return j >= 0 ? ((r[j] ?? "").toString().trim()) : "";
        };

        out.push({
          id: get("id"),
          added: get("added"),
          de: get("de"),
          foreign: get("foreign"),
          lang: (get("lang") || "EN").toUpperCase(),
          tags: get("tags"),
          example: get("example")
        });
      }
      return out;
    }

    // -------------------------
    // Tags recency map + sorted list
    // -------------------------
    function computeTagRecency() {
      const map = new Map();
      for (const v of vocab) {
        const d = parseISODate(v.added) || new Date(0);
        for (const t of parseTags(v.tags)) {
          const prev = map.get(t);
          if (!prev || d > prev) map.set(t, d);
        }
      }
      return map;
    }

    function tagDateStr(d) {
      if (!d) return "";
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,"0");
      const da = String(d.getDate()).padStart(2,"0");
      return `${y}-${m}-${da}`;
    }

    function getAllLangs() {
      return [...new Set(vocab.map(v => (v.lang || "EN").toUpperCase()).filter(Boolean))]
        .sort((a,b)=>a.localeCompare(b, "de"));
    }

    // -------------------------
    // Build session
    // -------------------------
    function buildSession() {
      let pool = vocab.slice();

      if (selectedLang !== "ALL") {
        pool = pool.filter(v => (v.lang || "").toUpperCase() === selectedLang);
      }

      if (selectedTags.size > 0) {
        pool = pool.filter(v => parseTags(v.tags).some(t => selectedTags.has(t)));
      }

      pool = pool.filter(v => (v.de || "").trim() && (v.foreign || "").trim());
      const sessionSize = (limitN === 0)
        ? pool.length
        : Math.min(limitN, pool.length);
    
      const c1 = [];
      const c2 = [];
      const c3 = [];
    
      for (const it of pool) {
        applyDecayIfNeededForId(it.id);
        const st = getVocabStateForId(it.id);
        const sc = st ? st.score : 0;
        const cat = getCategoryFromScore(sc);
        if (cat === 1) c1.push(it);
        else if (cat === 2) c2.push(it);
        else c3.push(it);
      }
    
      shuffle(c1); shuffle(c2); shuffle(c3);
    
      function computeTargets(n) {
        if (n <= 0) return { t1: 0, t2: 0, t3: 0 };
    
        const w1 = 4, w2 = 3, w3 = 2;
        const sum = w1 + w2 + w3;
    
        let t1 = Math.floor(n * w1 / sum);
        let t2 = Math.floor(n * w2 / sum);
        let t3 = Math.floor(n * w3 / sum);
    
        let used = t1 + t2 + t3;
        const remainders = [
          { k: 1, r: n * w1 / sum - t1 },
          { k: 2, r: n * w2 / sum - t2 },
          { k: 3, r: n * w3 / sum - t3 }
        ].sort((a,b) => b.r - a.r);
    
        let i = 0;
        while (used < n) {
          const k = remainders[i % remainders.length].k;
          if (k === 1) t1++;
          else if (k === 2) t2++;
          else t3++;
          used++;
          i++;
        }
    
        return { t1, t2, t3 };
      }
    
      const { t1, t2, t3 } = computeTargets(sessionSize);
    
      const picked = [];
      function take(arr, n) {
        const out = arr.slice(0, Math.max(0, n));
        arr.splice(0, out.length);
        return out;
      }
    
      picked.push(...take(c1, t1));
      picked.push(...take(c2, t2));
      picked.push(...take(c3, t3));
    
      function fillToSize() {
        while (picked.length < sessionSize) {
          if (c1.length) picked.push(c1.shift());
          else if (c2.length) picked.push(c2.shift());
          else if (c3.length) picked.push(c3.shift());
          else break; // nichts mehr da
        }
      }
      fillToSize();
    
      if (picked.length > sessionSize) picked.length = sessionSize;
    
      shuffle(picked);
    
      console.log("[Session categories/targets]", {
        pool: pool.length,
        sessionSize,
        targets: { cat1: t1, cat2: t2, cat3: t3 },
        available: {
          cat1: picked.filter(x => getCategoryFromScore(getVocabStateForId(x.id)?.score || 0) === 1).length,
          cat2: picked.filter(x => getCategoryFromScore(getVocabStateForId(x.id)?.score || 0) === 2).length,
          cat3: picked.filter(x => getCategoryFromScore(getVocabStateForId(x.id)?.score || 0) === 3).length
        }
      });
    
      session = picked;
      idx = 0;
      score = 0;
      inSession = session.length > 0;

      return inSession;
    }

    function currentItem() { return session[idx]; }

    function qText(item) {
      const dir = currentDirForQuestion;
      return dir === "DE_TO_FOREIGN" ? item.de : item.foreign;
    }
    function aText(item) {
      const dir = currentDirForQuestion;
      return dir === "DE_TO_FOREIGN" ? item.foreign : item.de;
    }

    // -------------------------
    // Learn UI
    // -------------------------
    function renderExampleUnder(targetEl, item) {
      const ex = (item.example || "").trim();
      if (!ex) return;
      const div = document.createElement("div");
      div.className = "small";
      div.style.marginTop = "6px";
      div.textContent = `Beispiel: ${ex}`;
      targetEl.appendChild(div);
    }

    function renderLearnInner(container) {
      container.innerHTML = "";

      if (!inSession) {
        container.innerHTML = `<div class="small">Keine aktive Session. Tippe auf ‚ÄûSession starten‚Äú.</div>`;
        return;
      }

      const item = currentItem();
        
      const nextBtn = $("nextBtn2");
      if (nextBtn) nextBtn.disabled = true;
        
      // direction logic per question
      currentDirForQuestion = (direction === "BOTH")
        ? (Math.random() < 0.5 ? "DE_TO_FOREIGN" : "FOREIGN_TO_DE")
        : direction;

      const head = document.createElement("div");
      head.innerHTML = `
        <div class="small" style="margin-bottom:8px;">
          Sprache: <span class="mono">${(item.lang||"").toUpperCase()}</span>
          ¬∑ Tags: <span class="mono">${item.tags||"-"}</span>
          ¬∑ Added: <span class="mono">${item.added||"-"}</span>
        </div>
        <div class="big">${qText(item)}</div>
      `;
      container.appendChild(head);

      if (mode === "FLASH") {
        const ans = document.createElement("div");
        ans.className = "answer";
        ans.innerHTML = `
          <div class="small">Klicke ‚ÄûAufdecken‚Äú, dann bewerte dich selbst.</div>
          <div class="row" style="margin-top:10px;">
            <button id="revealBtn">Aufdecken</button>
            <span class="right"></span>
          </div>
          <div id="revealArea" style="margin-top:10px; display:none;"></div>
          <div class="row" style="margin-top:10px;">
            <button id="selfOkBtn" class="btnOk" style="width:auto; padding:10px 12px;" disabled>Richtig</button>
            <button id="selfBadBtn" class="btnBad" style="width:auto; padding:10px 12px;" disabled>Falsch</button>
          </div>
        `;
        container.appendChild(ans);

        $("revealBtn").onclick = () => {
          const revealArea = $("revealArea");
          revealArea.style.display = "block";
          revealArea.innerHTML = "";

          const sol = document.createElement("div");
          sol.className = "big";
          sol.textContent = aText(item);
          revealArea.appendChild(sol);

          renderExampleUnder(revealArea, item);

          $("selfOkBtn").disabled = false;
          $("selfBadBtn").disabled = false;
        };

        $("selfOkBtn").onclick = () => { 
          score++; 
          applyAnswerScore(item.id, "FLASH", true);
          next(); 
        };
        
        $("selfBadBtn").onclick = () => { 
          applyAnswerScore(item.id, "FLASH", false);
          next(); 
        };

      } else if (mode === "MCQ") {
        const allSameLang = vocab.filter(v => (v.lang||"").toUpperCase() === (item.lang||"").toUpperCase());
        const correct = aText(item);

        const distractors = shuffle(
          allSameLang
            .filter(v => v !== item)
            .map(v => aText(v))
            .filter(t => normalize(t, true) !== normalize(correct, true))
        ).slice(0, 3);

        const choices = shuffle([correct, ...distractors]);

        const wrap = document.createElement("div");
        wrap.className = "choices";

        choices.forEach(ch => {
          const b = document.createElement("button");
          b.textContent = ch;
          b.onclick = () => {
            const ok = normalize(ch, true) === normalize(correct, true);
            if (ok) { b.classList.add("ok"); score++; }
            else { b.classList.add("bad"); }

            applyAnswerScore(item.id, "MCQ", ok);

            [...wrap.querySelectorAll("button")].forEach(x => x.disabled = true);

            const reveal = document.createElement("div");
            reveal.className = "small";
            reveal.style.marginTop = "10px";

            if (ok) reveal.innerHTML = `<span class="pill ok">‚úî richtig</span>`;
            else reveal.innerHTML = `<span class="pill bad">‚úò falsch</span> <span class="mono">Richtig: ${correct}</span>`;

            renderExampleUnder(reveal, item);
            container.appendChild(reveal);
              
            $("nextBtn2").disabled = false;
          };
          wrap.appendChild(b);
        });

        container.appendChild(wrap);

        const hint = document.createElement("div");
        hint.className = "small";
        hint.style.marginTop = "8px";
        hint.textContent = "Danach auf ‚ÄûN√§chste‚Äú tippen.";
        container.appendChild(hint);

      } else if (mode === "TYPE") {
        const correct = aText(item);

        const area = document.createElement("div");
        area.className = "answer";
        area.innerHTML = `
          <div class="field">
            <label>Deine Antwort</label>
            <input id="typeInput" placeholder="Antwort eintippen" />
          </div>
          <div class="row">
            <button id="checkBtn" class="btnPrimary" style="width:auto; padding:10px 12px;">Pr√ºfen</button>
            <button id="showBtn">L√∂sung zeigen</button>
          </div>
          <div id="feedback" class="small" style="margin-top:10px;"></div>
        `;
        container.appendChild(area);
        $("typeInput").focus();
          
        let typeAnswered = false;

        const markAnswered = () => {
          typeAnswered = true;
          $("checkBtn").disabled = true;
          $("typeInput").disabled = true;
          $("nextBtn2").disabled = false;
        };
        
        const renderSolutionWithExample = (html) => {
          const fb = $("feedback");
          fb.innerHTML = html;
          renderExampleUnder(fb, item);
        };
        
        $("checkBtn").onclick = () => {
          if (typeAnswered) return;
        
          const user = $("typeInput").value;
          const ok = normalize(user, lenient) === normalize(correct, lenient);
        
          if (ok) score++;
          applyAnswerScore(item.id, "TYPE", ok);
        
          renderSolutionWithExample(
            ok
              ? `<span class="pill ok">‚úî richtig</span>`
              : `<span class="pill bad">‚úò falsch</span> <span class="mono">Richtig: ${correct}</span>`
          );
        
          markAnswered();
        };
        
        $("showBtn").onclick = () => {
          if (typeAnswered) return;
        
          renderSolutionWithExample(`<span class="mono">L√∂sung: ${correct}</span>`);
          applyAnswerScore(item.id, "TYPE", false);
          markAnswered();
        };

        const hint = document.createElement("div");
        hint.className = "small";
        hint.style.marginTop = "8px";
        hint.textContent = "Danach auf ‚ÄûN√§chste‚Äú tippen.";
        container.appendChild(hint);
      }
    }

    function openOverlay() {
      $("learnOverlay").classList.add("open");
      $("learnOverlay").setAttribute("aria-hidden", "false");
      document.body.classList.add("noscroll");
      syncOverlayButtons();
      renderLearnInner($("learnCardInner"));
      $("learnOverlay").querySelector(".overlayPanel").scrollTop = 0;
    }

    function closeOverlay() {
      $("learnOverlay").classList.remove("open");
      $("learnOverlay").setAttribute("aria-hidden", "true");
      document.body.classList.remove("noscroll");
    }

    function syncOverlayButtons() {
      const isFlash = (mode === "FLASH");
    
      $("endBtn2").disabled = !inSession;
    
      $("nextBtn2").style.display = isFlash ? "none" : "";
    }

    function next() {
      if (!inSession) return;
    
      if (idx < session.length - 1) {
        idx++;
      } else {
        inSession = false;
      }
    
      syncOverlayButtons();
      renderLearnInner($("learnCardInner"));
    }

    function endSession() {
      inSession = false;
      session = [];
      idx = 0;
      renderLearnInner($("learnCardInner"));
      syncOverlayButtons();
      closeOverlay();
    }

    // -------------------------
    // CSV table
    // -------------------------
    function renderCsvTable() {
      const host = $("vocabList");
      if (!host) return;
      host.innerHTML = "";
    
      // Alphabetisch nach Fremdsprache
      const rows = vocab.slice().sort((a, b) => {
        const fa = (a.foreign || "").trim();
        const fb = (b.foreign || "").trim();
        return fa.localeCompare(fb, "de", { sensitivity: "base" });
      });

      const q = normalize(vocabSearchQuery, true);
      const filtered = q
        ? rows.filter(it => {
            const f = normalize(it.foreign || "", true);
            const d = normalize(it.de || "", true);
            return f.includes(q) || d.includes(q);
          })
        : rows;
        
      for (const it of filtered) {
        const d = document.createElement("details");
        d.className = "vocabEntry";
    
        const s = document.createElement("summary");
    
        const w = document.createElement("div");
        w.className = "vocabWord";
        w.textContent = (it.foreign || "").trim() || "‚Äî";
    
        const m = document.createElement("div");
        m.className = "vocabMeta";
        // optional: Sprache anzeigen
        m.textContent = (it.lang || "").toUpperCase();
    
        s.appendChild(w);
        s.appendChild(m);
    
        const body = document.createElement("div");
        body.className = "vocabBody";
    
        const lineDe = document.createElement("div");
        lineDe.className = "vocabLine";
        lineDe.innerHTML = `<span class="k">DE:</span>${(it.de || "‚Äî")}`;
    
        const lineEx = document.createElement("div");
        lineEx.className = "vocabLine";
        const ex = (it.example || "").trim();
        lineEx.innerHTML = ex ? `<span class="k">Beispiel:</span>${ex}` : `<span class="k">Beispiel:</span>‚Äî`;
    
        const lineTags = document.createElement("div");
        lineTags.className = "vocabLine";
        const tags = (it.tags || "").trim();
        lineTags.innerHTML = tags ? `<span class="k">Tags:</span>${tags}` : `<span class="k">Tags:</span>‚Äî`;
    
        body.appendChild(lineDe);
        body.appendChild(lineEx);
        body.appendChild(lineTags);
        const lineAdded = document.createElement("div");
        lineAdded.className = "vocabLine";
        const added = (it.added || "").trim();
        lineAdded.innerHTML = added ? `<span class="k">Added:</span>${added}` : `<span class="k">Added:</span>‚Äî`;

        body.appendChild(lineAdded);
    
        d.appendChild(s);
        d.appendChild(body);
    
        host.appendChild(d);
      }
    
      $("csvCountLabel").textContent = `${filtered.length} / ${vocab.length}`;
    }

    // -------------------------
    // Home labels
    // -------------------------
    function directionLabel(v){
      if (v === "DE_TO_FOREIGN") return "Deutsch ‚Üí Fremdsprache";
      if (v === "FOREIGN_TO_DE") return "Fremdsprache ‚Üí Deutsch";
      return "Beide Richtungen (gemischt)";
    }
    function modeLabel(v){
      if (v === "FLASH") return "Karteikarten (richtig/falsch)";
      if (v === "MCQ") return "Multiple Choice";
      return "Eingabe";
    }

    function updateLabels() {
      $("labelLang").textContent = (selectedLang === "ALL") ? "Alle Sprachen" : selectedLang;
      $("labelDirection").textContent = directionLabel(direction);
      $("labelMode").textContent = modeLabel(mode);
      $("labelLimit").textContent = (limitN === 0) ? "Alle" : String(limitN);
      $("labelLenient").textContent = lenient ? "an (ignoriert Gro√ü/Klein + Akzente)" : "aus";

      if (selectedTags.size === 0) $("labelTags").textContent = "Alle";
      else if (selectedTags.size === 1) $("labelTags").textContent = [...selectedTags][0];
      else $("labelTags").textContent = `${selectedTags.size} ausgew√§hlt`;

    }

    // -------------------------
    // Modal helpers
    // -------------------------
    let modalOnOk = null;
    
    function openModal(title, buildBodyFn, onOkFn) {
      $("modalTitle").textContent = title;
    
      // ‚úÖ Reset IMMER zuerst (damit Spezial-Modals danach √ºberschreiben k√∂nnen)
      if ($("modalCancelBtn")) $("modalCancelBtn").style.display = "";
      if ($("modalGoBtn")) {
        $("modalGoBtn").textContent = "Los geht's";
        $("modalGoBtn").disabled = true;
      }
    
      const body = $("modalBody");
      body.innerHTML = "";
    
      // Jetzt darf das Modal seinen Spezialzustand setzen
      buildBodyFn(body);
    
      modalOnOk = onOkFn || null;
    
      $("modal").classList.add("open");
      $("modal").setAttribute("aria-hidden", "false");
      document.body.classList.add("noscroll");
    }

    function closeModal(trigger) {
      $("modal").classList.remove("open");
      $("modal").setAttribute("aria-hidden", "true");
      document.body.classList.remove("noscroll");

      if (trigger === "ok" && typeof modalOnOk === "function") modalOnOk();

      modalOnOk = null;
    }

    // -------------------------
    // Option modals
    // -------------------------
    function openLangModal() {
      const langs = getAllLangs();
      let temp = selectedLang;

      openModal(
        "Sprache",
        (body) => {
          $("modalGoBtn").disabled = false;
          $("modalGoBtn").textContent = "OK";
          const wrap = document.createElement("div");
          wrap.className = "field";
          wrap.innerHTML = `<label>Sprache ausw√§hlen</label>`;
          const sel = document.createElement("select");

          const oAll = document.createElement("option");
          oAll.value = "ALL";
          oAll.textContent = "Alle Sprachen";
          sel.appendChild(oAll);

          langs.forEach(l => {
            const o = document.createElement("option");
            o.value = l;
            o.textContent = l;
            sel.appendChild(o);
          });

          sel.value = temp;
          sel.onchange = () => { temp = sel.value; };

          wrap.appendChild(sel);
          body.appendChild(wrap);

          const note = document.createElement("div");
          note.className = "small";
          note.textContent = "Filter wirkt bei neuer Session.";
          body.appendChild(note);
        },
        () => { selectedLang = temp; updateLabels(); }
      );
    }

    function openDirectionModal() {
      let temp = direction;
      openModal(
        "Richtung",
        (body) => {
          $("modalGoBtn").disabled = false;
          $("modalGoBtn").textContent = "OK";
          const wrap = document.createElement("div");
          wrap.className = "field";
          wrap.innerHTML = `<label>Richtung ausw√§hlen</label>`;
          const sel = document.createElement("select");
          [
            ["DE_TO_FOREIGN","Deutsch ‚Üí Fremdsprache"],
            ["FOREIGN_TO_DE","Fremdsprache ‚Üí Deutsch"],
            ["BOTH","Beide Richtungen (gemischt)"]
          ].forEach(([v,t]) => {
            const o = document.createElement("option");
            o.value = v; o.textContent = t;
            sel.appendChild(o);
          });
          sel.value = temp;
          sel.onchange = () => { temp = sel.value; };
          wrap.appendChild(sel);
          body.appendChild(wrap);

        },
        () => { direction = temp; updateLabels(); }
      );
    }

    function openModeModal() {
      let temp = mode;
      openModal(
        "Modus",
        (body) => {
          $("modalGoBtn").disabled = false;
          $("modalGoBtn").textContent = "OK";
          const wrap = document.createElement("div");
          wrap.className = "field";
          wrap.innerHTML = `<label>Modus ausw√§hlen</label>`;
          const sel = document.createElement("select");
          [
            ["FLASH","Karteikarten (richtig/falsch)"],
            ["MCQ","Multiple Choice"],
            ["TYPE","Eingabe"]
          ].forEach(([v,t]) => {
            const o = document.createElement("option");
            o.value = v; o.textContent = t;
            sel.appendChild(o);
          });
          sel.value = temp;
          sel.onchange = () => { temp = sel.value; };
          wrap.appendChild(sel);
          body.appendChild(wrap);

          const note = document.createElement("div");
          note.className = "small";
          note.textContent = "Filter wirkt bei neuer Session.";
          body.appendChild(note);
        },
        () => { mode = temp; updateLabels(); syncOverlayButtons(); }
      );
    }

    function openLimitModal() {
      let temp = (limitN === 0) ? "0" : String(limitN);
    
      openModal(
        "Anzahl Fragen",
        (body) => {
          $("modalGoBtn").disabled = false;
          $("modalGoBtn").textContent = "OK";
          const wrap = document.createElement("div");
          wrap.className = "field";
          wrap.innerHTML = `<label>Anzahl ausw√§hlen</label>`;
    
          const sel = document.createElement("select");
          [
            ["0", "Unbegrenzt"],
            ["25", "25"],
            ["50", "50"],
            ["75", "75"],
            ["100", "100"]
          ].forEach(([v, t]) => {
            const o = document.createElement("option");
            o.value = v;
            o.textContent = t;
            sel.appendChild(o);
          });
    
          sel.value = temp;
          sel.onchange = () => { temp = sel.value; };
    
          wrap.appendChild(sel);
          body.appendChild(wrap);
    
          const note = document.createElement("div");
          note.className = "small";
          note.textContent = "Die Einstellung wirkt bei neuer Session.";
          body.appendChild(note);
        },
        () => {
          const n = Number(temp);
          limitN = (!Number.isFinite(n) || n <= 0) ? 0 : n;
          updateLabels();
        }
      );
    }

    function openLenientModal() {
      let temp = lenient;
      openModal(
        "Akzente & Gro√ü/klein ignorieren",
        (body) => {
          $("modalGoBtn").disabled = false;
          $("modalGoBtn").textContent = "OK";
          const wrap = document.createElement("div");
          wrap.className = "field";
          wrap.innerHTML = `<label>Gro√ü/Klein & Akzente ignorieren (nur Eingabe)</label>`;
          const sel = document.createElement("select");
          const o1 = document.createElement("option"); o1.value="OFF"; o1.textContent="aus";
          const o2 = document.createElement("option"); o2.value="ON"; o2.textContent="an";
          sel.appendChild(o1); sel.appendChild(o2);
          sel.value = temp ? "ON" : "OFF";
          sel.onchange = () => { temp = sel.value === "ON"; };
          wrap.appendChild(sel);
          body.appendChild(wrap);
          const expl = document.createElement("div");
          expl.className = "small";
          expl.innerHTML =
            "‚Ä¢ <span class=\"mono\">aus</span>: Deine Eingabe muss exakt passen.<br>" +
            "‚Ä¢ <span class=\"mono\">an</span>: Gro√ü/Klein und Akzente werden ignoriert (z.&nbsp;B. \"caf√©\" = \"Cafe\").";
          expl.style.marginTop = "8px";
          body.appendChild(expl);
        },
        () => { lenient = temp; updateLabels(); }
      );
    }

    function selectTagsByRecencyInSet(tagLatest, days, set) {
      const cutoff = new Date();
      cutoff.setDate(cutoff.getDate() - days);
      for (const [t, d] of tagLatest.entries()) {
        if ((d || new Date(0)) >= cutoff) set.add(t);
      }
    }

    function openTagsModal() {
      const tagLatest = computeTagRecency();
      const sortedTags = [...tagLatest.keys()].sort((a,b) => {
        const da = tagLatest.get(a) || new Date(0);
        const db = tagLatest.get(b) || new Date(0);
        if (db.getTime() !== da.getTime()) return db - da;  // neueste oben
        return a.localeCompare(b, "de");
      });

      // temp copy
      const temp = new Set(selectedTags);

      openModal(
        "Units/Tags",
        (body) => {
          $("modalGoBtn").disabled = false;
          $("modalGoBtn").textContent = "OK";
          const quick = document.createElement("div");
          quick.className = "row";
          quick.style.gap = "10px";
          quick.innerHTML = `
            <button id="t30">letzte 30 Tage</button>
            <button id="t90">letzte 90 Tage</button>
            <button id="tAll">alle</button>
            <button id="tNone">keine</button>
          `;
          body.appendChild(quick);

          const list = document.createElement("div");
          list.className = "tagList";

          function renderList() {
            list.innerHTML = "";
            sortedTags.forEach(t => {
              const d = tagLatest.get(t) || new Date(0);
              const row = document.createElement("div");
              row.className = "tagRow";

              const cb = document.createElement("input");
              cb.type = "checkbox";
              cb.checked = temp.has(t);
              cb.onchange = () => {
                if (cb.checked) temp.add(t);
                else temp.delete(t);
              };

              const name = document.createElement("div");
              name.className = "name";
              name.textContent = t;

              const date = document.createElement("div");
              date.className = "date";
              date.textContent = tagDateStr(d);

              row.appendChild(cb);
              row.appendChild(name);
              row.appendChild(date);

              row.addEventListener("click", (e) => {
                if (e.target === cb) return;
                cb.checked = !cb.checked;
                cb.dispatchEvent(new Event("change"));
              });

              list.appendChild(row);
            });
          }

          renderList();
          body.appendChild(list);

          // wire quick buttons
          $("t30").onclick = () => { temp.clear(); selectTagsByRecencyInSet(tagLatest, 30, temp); renderList(); };
          $("t90").onclick = () => { temp.clear(); selectTagsByRecencyInSet(tagLatest, 90, temp); renderList(); };
          $("tAll").onclick = () => { temp.clear(); sortedTags.forEach(t => temp.add(t)); renderList(); };
          $("tNone").onclick = () => { temp.clear(); renderList(); };

          const note = document.createElement("div");
          note.className = "small";
          note.textContent = "Sortierung: neueste Units oben (nach Added-Datum). Filter wirkt bei neuer Session.";
          body.appendChild(note);
        },
        () => { selectedTags = temp; updateLabels(); }
      );
    }

    function openLearnModal() {
      if (!vocab || vocab.length === 0) return;
    
      const tagLatest = computeTagRecency();
    
      // Alle Tags: neueste oben
      const sortedAll = [...tagLatest.keys()].sort((a,b) => {
        const da = tagLatest.get(a) || new Date(0);
        const db = tagLatest.get(b) || new Date(0);
        if (db.getTime() !== da.getTime()) return db - da;
        return a.localeCompare(b, "de");
      });
    
      // Auswahl unten im Modal (Checkbox-Liste)
      const temp = new Set();
    
      openModal(
        "Units/Tags ausw√§hlen",
        (body) => {
          $("modalGoBtn").textContent = "Los geht's";
          const syncGo = () => {
            $("modalGoBtn").disabled = temp.size === 0;
          };
          syncGo();

          const h = document.createElement("div");
          h.className = "sectionLbl";
          h.style.marginTop = "0";
          h.innerHTML = `<span class="mini">üè∑</span><span>Alle Units/Tags</span>`;
          body.appendChild(h);
    
          const list = document.createElement("div");
          list.className = "tagList";
    
          function renderList() {
            list.innerHTML = "";
            sortedAll.forEach(t => {
              const d = tagLatest.get(t) || new Date(0);
    
              const row = document.createElement("div");
              row.className = "tagRow";
    
              const cb = document.createElement("input");
              cb.type = "checkbox";
              cb.checked = temp.has(t);
              cb.onchange = () => {
                if (cb.checked) temp.add(t);
                else temp.delete(t);
                syncGo();
              };
    
              const name = document.createElement("div");
              name.className = "name";
              name.textContent = t;
    
              const date = document.createElement("div");
              date.className = "date";
              date.textContent = tagDateStr(d);
    
              row.appendChild(cb);
              row.appendChild(name);
              row.appendChild(date);
    
              row.addEventListener("click", (e) => {
                if (e.target === cb) return;
                cb.checked = !cb.checked;
                cb.dispatchEvent(new Event("change"));
              });
    
              list.appendChild(row);
            });
          }
    
          renderList();
          body.appendChild(list);
    
          const note = document.createElement("div");
          note.className = "small";
          note.textContent = "Sortierung: neueste Units oben (nach Added-Datum).";
          body.appendChild(note);
    
          syncGo();
        },
        
          () => {
          // speichern & Card 3 aktualisieren
          saveRecentLearnTagsFromSet(temp);
          renderRecentLearnPills();
        
          // Lerntabelle √∂ffnen
          openLearnListModal(temp);
        }
      );
    }
    
    // -------------------------
    // Card 3: Zuletzt gelernt
    // -------------------------
    function loadRecentLearnTags() {
      try {
        const raw = localStorage.getItem(LS_LEARN_TAGS_KEY);
        const arr = raw ? JSON.parse(raw) : [];
        return Array.isArray(arr) ? arr.filter(Boolean) : [];
      } catch {
        return [];
      }
    }
    
    function renderRecentLearnPills() {
      const host = $("recentLearnTags");
      const btn = $("learnStartBtn");
      if (!host) return;
    
      host.innerHTML = "";
    
      const recent = loadRecentLearnTags().slice(0, 3);
    
      // Button erst aktivieren, wenn CSV da ist
      if (btn) btn.disabled = (vocab.length === 0);
    
      if (recent.length === 0) {
        const div = document.createElement("div");
        div.className = "small";
        div.textContent = "Noch nichts gespeichert.";
        host.appendChild(div);
        return;
      }
    
      recent.forEach(t => {
        const b = document.createElement("button");
        b.className = "learnPillBtn";
        b.textContent = t;
    
        // Platzhalter ‚Äì echte Funktion kommt sp√§ter
        b.onclick = () => {
          // Klick z√§hlt als "neueste Auswahl"
          saveRecentLearnTagsFromSet(new Set([t]));
          renderRecentLearnPills();
          openLearnListModal(new Set([t]));
        };
    
        host.appendChild(b);
      });
    }
    
    function saveRecentLearnTagsFromSet(tagSet) {
      const chosen = [...tagSet].filter(Boolean);
      if (chosen.length === 0) return;
    
      const current = loadRecentLearnTags();
    
      const next = [];
      for (const t of chosen) if (!next.includes(t)) next.push(t);
      for (const t of current) if (!next.includes(t)) next.push(t);
    
      localStorage.setItem(LS_LEARN_TAGS_KEY, JSON.stringify(next.slice(0, 10)));
    }

    function openLearnListModal(tagSet) {
      if (!vocab || vocab.length === 0) return;
    
      const tags = new Set([...tagSet].filter(Boolean));
      if (tags.size === 0) return;
    
      let pool = vocab.filter(v =>
        parseTags(v.tags).some(t => tags.has(t))
      );
    
      openModal(
        "Lerntabelle (Fremdsprache ‚Üí Deutsch)",
        (body) => {
          if ($("modalGoBtn")) {
            $("modalGoBtn").disabled = false;   // ‚úÖ klickbar
            $("modalGoBtn").textContent = "OK"; // ‚úÖ Beschriftung
          }
          if ($("modalCancelBtn")) $("modalCancelBtn").style.display = "none"; // ‚úÖ nur OK sichtbar

          const sel = document.createElement("div");
          sel.className = "small";
          sel.innerHTML = `Auswahl: <span class="mono">${[...tags].join(" ¬∑ ")}</span>`;
          body.appendChild(sel);
    
          const cnt = document.createElement("div");
          cnt.className = "small";
          cnt.textContent = `${pool.length} Vokabeln`;
          body.appendChild(cnt);
    
          const list = document.createElement("div");
          list.className = "learnList";
    
          if (pool.length === 0) {
            const empty = document.createElement("div");
            empty.className = "small";
            empty.textContent = "Keine passenden Vokabeln.";
            body.appendChild(empty);
            return;
          }
    
          for (const it of pool) {
            const row = document.createElement("div");
            row.className = "learnRow";
    
            const f = document.createElement("div");
            f.className = "f";
            f.textContent = it.foreign || "‚Äî";
    
            const d = document.createElement("div");
            d.className = "d";
            d.textContent = it.de || "‚Äî";
    
            const ex = document.createElement("div");
            ex.className = "ex";
            const example = (it.example || "").trim();
            ex.textContent = example ? example : ""; // wenn leer: einfach nichts
            
            row.appendChild(f);
            row.appendChild(d);
            if (example) row.appendChild(ex);
    
            list.appendChild(row);
          }
    
          body.appendChild(list);
        },
        null
      );
    }

    // -------------------------
    // Wiring
    // -------------------------
    $("nextBtn2").addEventListener("click", next);
    $("endBtn2").addEventListener("click", endSession);

    $("startBtn").addEventListener("click", () => {
      if (vocab.length === 0) return alert("Keine Vokabeln vorhanden.");
      const ok = buildSession();
      if (!ok) return alert("Keine passenden Vokabeln f√ºr deine Filter (Sprache/Tags).");
      inSession = true;
      openOverlay();
    });

    $("modal").addEventListener("click", (e) => {
      if (e.target === $("modal")) closeModal("cancel");
    });
    
    // Open modals
    $("pickLang").addEventListener("click", openLangModal);
    $("pickDirection").addEventListener("click", openDirectionModal);
    $("pickMode").addEventListener("click", openModeModal);
    $("pickLimit").addEventListener("click", openLimitModal);
    $("pickLenient").addEventListener("click", openLenientModal);
    $("pickTags").addEventListener("click", openTagsModal);
    $("learnStartBtn").addEventListener("click", openLearnModal);
    $("modalCancelBtn").addEventListener("click", () => closeModal("cancel"));
    $("modalGoBtn").addEventListener("click", () => closeModal("ok"));

    // -------------------------
    // INIT
    // -------------------------
    async function init() {
      $("csvLabel").textContent = CSV_URL;
      $("startBtn").disabled = true;

      // defaults on labels
      updateLabels();

      try {
        const r = await fetch(CSV_URL, { cache: "no-store" });
        if (!r.ok) throw new Error("CSV not found");
        const text = await r.text();
        const items = fromCsv(text);

        vocab = items
          .filter(it => (it.de || it.foreign) && (it.lang || "").trim())
          .map(it => ({
            id: (it.id || "").toString().trim(),
            added: (it.added || "").trim(),
            de: (it.de || "").trim(),
            foreign: (it.foreign || "").trim(),
            lang: (it.lang || "EN").toUpperCase().trim(),
            tags: (it.tags || "").trim(),
            example: (it.example || "").trim()
          }))
          .filter(it => it.de && it.foreign);

        APP_STATE = loadRootState();
        ensureVocabStatesFromCsv(APP_STATE, vocab);
        for (const it of vocab) {
          applyDecayIfNeededForId(it.id);
        }
        saveRootState(APP_STATE);
          
        renderCsvTable();

        const searchEl = $("vocabSearch");
        if (searchEl) {
          searchEl.value = "";
          searchEl.oninput = () => {
            vocabSearchQuery = searchEl.value || "";
            renderCsvTable();
          };
        }
          
        $("startBtn").disabled = vocab.length === 0;

        // Card 3 aktivieren, sobald CSV geladen ist
        $("learnStartBtn").disabled = vocab.length === 0;
        renderRecentLearnPills();
          
        updateLabels();
      } catch (e) {
        vocab = [];
        renderCsvTable();
        updateLabels();
        $("startBtn").disabled = true;
        if ($("learnStartBtn")) $("learnStartBtn").disabled = true;
        renderRecentLearnPills();
      }
    }

    init();
  </script>
</body>
</html>
